<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Ğ©Ğ¾Ğ´ĞµĞ½Ğ½Ğ¸Ğº ĞšĞ»Ğ°ÑÑƒ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        :root {
            --bg: #000;
            --card: rgba(28, 28, 30, .75);
            --text: #fff;
            --muted: rgba(235, 235, 245, .6);
            --accent: #bf5af2;
            --accent2: #7d5cff;
            --border: rgba(84, 84, 88, .65);
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            -webkit-font-smoothing: antialiased;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden
        }

        @keyframes slideUpFade {
            0% {
                opacity: 0;
                transform: translateY(24px) scale(.98)
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1)
            }
        }

        @keyframes fadeIn {
            0% {
                opacity: 0
            }

            100% {
                opacity: 1
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1)
            }

            50% {
                opacity: .7;
                transform: scale(.95)
            }

            100% {
                opacity: 1;
                transform: scale(1)
            }
        }

        @keyframes popGlow {
            0% {
                transform: translateY(10px) scale(.98);
                box-shadow: 0 0 0 rgba(191, 90, 242, 0)
            }

            55% {
                transform: translateY(0) scale(1.015);
                box-shadow: 0 0 26px rgba(191, 90, 242, .25)
            }

            100% {
                transform: translateY(0) scale(1);
                box-shadow: 0 0 0 rgba(191, 90, 242, 0)
            }
        }

        .hw-card.new-task {
            border: 1px solid rgba(191, 90, 242, .35);
            background: rgba(28, 28, 30, .80);
            animation: popGlow .6s cubic-bezier(.2, .8, .2, 1) both
        }

        .header-container {
            text-align: center;
            margin-bottom: 24px;
            margin-top: 8px;
            animation: fadeIn .6s ease-out
        }

        .time-display {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: .5px
        }

        .date-display {
            font-size: 15px;
            color: var(--muted);
            font-weight: 500;
            margin-top: 2px
        }

        .tabs-wrapper {
            position: relative;
            background: rgba(118, 118, 128, .30);
            border-radius: 10px;
            padding: 3px;
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn .8s ease-out;
            border: .5px solid rgba(84, 84, 88, .45)
        }

        .tab-indicator {
            position: absolute;
            top: 3px;
            bottom: 3px;
            left: 3px;
            border-radius: 8px;
            z-index: 1;
            background: linear-gradient(135deg, rgba(191, 90, 242, .45), rgba(125, 92, 255, .40));
            border: 1px solid rgba(255, 255, 255, .14);
            box-shadow: 0 10px 26px rgba(0, 0, 0, .45), 0 0 18px rgba(191, 90, 242, .12);
            transition: transform .35s cubic-bezier(.25, 1, .5, 1), width .35s cubic-bezier(.25, 1, .5, 1)
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 7px 0;
            font-size: 13px;
            font-weight: 700;
            color: rgba(235, 235, 245, .72);
            border-radius: 8px;
            cursor: pointer;
            transition: color .25s, transform .18s, opacity .18s;
            position: relative;
            z-index: 2;
            transform: translateZ(0);
            will-change: transform;
        }

        .tab.active {
            color: var(--text);
            transform: scale(1.01)
        }

        #hw-container,
        #all-hw-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-bottom: 120px
        }

        .hw-card {
            background: var(--card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 14px;
            padding: 14px 16px;
            position: relative;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: transform .2s cubic-bezier(.34, 1.56, .64, 1), background-color .2s
        }

        .hw-card:active {
            transform: scale(.94);
            background-color: rgba(44, 44, 46, .85)
        }

        .hw-card::after {
            content: 'â€º';
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: var(--muted);
            font-weight: 300;
            transition: transform .2s
        }

        .hw-card:active::after {
            transform: translateY(-50%) translateX(4px)
        }

        .subj-title {
            font-size: 16px;
            font-weight: 600;
            padding-right: 20px
        }

        .hw-short {
            font-size: 14px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 20px;
            margin-top: 2px
        }

        .filter-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            overflow-y: visible;
            padding: 6px 2px 14px;
            margin-bottom: 12px;
            align-items: center;
            -webkit-overflow-scrolling: touch;
        }

        .filter-scroll::-webkit-scrollbar {
            display: none
        }

        .filter-pill {
            padding: 8px 16px;
            background: rgba(118, 118, 128, .24);
            border-radius: 16px;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            color: var(--muted);
            cursor: pointer;
            transition: transform .16s, background .2s, color .2s, opacity .15s;
            transform: translateZ(0);
            will-change: transform;
        }

        .filter-pill.active {
            background: var(--text);
            color: var(--bg);
        }

        /* ĞŸĞ›ĞĞ’ĞĞ• "ĞĞĞ¢Ğ˜Ğ¡ĞšĞĞĞĞ¯" Ğ±ĞµĞ· Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºÑƒ keyframes */
        .pressable {
            transform-origin: center;
            will-change: transform, opacity;
        }

        .pressable.is-pressed {
            transform: scale(.94);
            opacity: .78;
        }

        .bottom-dock {
            position: fixed;
            bottom: calc(24px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 28px;
            background: rgba(28, 28, 30, .75);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            padding: 10px 28px;
            border-radius: 36px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, .6);
            border: .5px solid rgba(84, 84, 88, .5);
            z-index: 100;
            animation: dockAppear .6s ease-out forwards;
        }

        @keyframes dockAppear {
            from {
                opacity: 0;
                bottom: calc(0px + env(safe-area-inset-bottom));
            }

            to {
                opacity: 1;
                bottom: calc(24px + env(safe-area-inset-bottom));
            }
        }

        .dock-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: .2s;
            width: 56px
        }

        .dock-btn:active {
            transform: scale(.85);
            color: var(--text)
        }

        .dock-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            opacity: .95
        }

        .dock-fab {
            width: 52px;
            height: 52px;
            border-radius: 26px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 34px;
            font-weight: 300;
            box-shadow: 0 8px 26px rgba(191, 90, 242, .30);
            cursor: pointer;
            transition: .2s;
            margin: 0 4px
        }

        .dock-fab:active {
            transform: scale(.85)
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            transform: translateX(100%);
            transition: transform .4s cubic-bezier(.32, .72, 0, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 30px rgba(0, 0, 0, .5);
            z-index: 1000
        }

        .modal-overlay.open {
            transform: translateX(0)
        }

        #detail-modal {
            z-index: 1010
        }

        #edit-hw-modal {
            z-index: 1020
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            background: rgba(28, 28, 30, .85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-bottom: .5px solid var(--border);
            z-index: 10
        }

        .back-btn {
            color: var(--accent);
            font-size: 17px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: opacity .2s
        }

        .back-btn:active {
            opacity: .5
        }

        .back-btn::before {
            content: 'â€¹';
            font-size: 28px;
            line-height: 1;
            margin-right: 4px;
            margin-top: -3px
        }

        .modal-title-center {
            font-size: 17px;
            font-weight: 600;
            position: absolute;
            left: 50%;
            transform: translateX(-50%)
        }

        .modal-content {
            padding: 20px 16px;
            overflow-y: auto;
            flex: 1
        }

        .modal-subj {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: .3px;

            text-align: center;
            /* Ñ†ĞµĞ½Ñ‚Ñ€ */
            padding: 0 10px;
            /* Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¸Ğ¿Ğ°Ğ»Ğ¾ Ğ´Ğ¾ ĞºÑ€Ğ°Ñ—Ğ² */
            word-break: break-word;
            /* Ğ´Ğ¾Ğ²Ğ³Ñ– Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ½Ğµ Ñ€Ğ²ÑƒÑ‚ÑŒ layout */
        }

        .modal-subj {
            line-height: 1.15;
            text-wrap: balance;
        }

        /* ĞĞ¾Ğ²Ğ¸Ğ¹ "meta" Ğ±Ğ»Ğ¾Ğº Ñƒ Ğ´ĞµÑ‚Ğ°Ğ»ÑÑ… */
        .detail-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 14px;
            color: rgba(235, 235, 245, .78);
            font-weight: 600;
            font-size: 13px;
        }

        .detail-meta .chip {
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(118, 118, 128, .18);
            border: 1px solid rgba(84, 84, 88, .35);
            white-space: nowrap;
        }

        .detail-meta .chip.accent {
            background: rgba(191, 90, 242, .14);
            border: 1px solid rgba(191, 90, 242, .30);
            color: #ead8ff;
        }

        .modal-block {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px
        }

        .modal-label {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 8px;
            letter-spacing: .5px
        }

        .modal-desc {
            font-size: 16px;
            line-height: 1.5;
            white-space: pre-wrap
        }

        .week-pills {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .pill {
            min-width: 44px;
            text-align: center;
            background: rgba(118, 118, 128, .24);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 700;
            color: var(--muted);
            transition: all .3s
        }

        .pill.active {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff;
            transform: scale(1.03)
        }

        .lesson-row {
            display: flex;
            align-items: center;
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            opacity: 0;
            border: 1px solid transparent;
            transition: all .3s
        }

        .lesson-num {
            font-size: 14px;
            font-weight: 700;
            color: var(--muted);
            width: 20px
        }

        .lesson-time {
            font-size: 13px;
            color: var(--accent);
            font-weight: 500;
            width: 50px;
            text-align: right;
            margin-right: 12px
        }

        .lesson-name {
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center
        }

        .lesson-break {
            justify-content: center;
            background: transparent;
            border: 1px dashed var(--border);
            color: var(--muted);
            font-size: 14px;
            padding: 8px
        }

        .lesson-row.current-lesson {
            border: 1px solid rgba(191, 90, 242, .85);
            background: rgba(191, 90, 242, .10);
            box-shadow: 0 0 18px rgba(191, 90, 242, .12)
        }

        .current-badge {
            background: linear-gradient(135deg, rgba(191, 90, 242, .95), rgba(125, 92, 255, .95));
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 8px;
            border: 1px solid rgba(255, 255, 255, .22);
            box-shadow: 0 6px 18px rgba(191, 90, 242, .20);
            animation: pulse 2s infinite
        }

        .admin-badge {
            display: inline-flex;
            align-items: center;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: .6px;
            padding: 2px 8px;
            border-radius: 999px;
            background: linear-gradient(135deg, rgba(191, 90, 242, .95), rgba(125, 92, 255, .95));
            color: #fff;
            border: 1px solid rgba(255, 255, 255, .25);
            animation: pulse 2s infinite;
            margin-right: 8px
        }

        .ios-input {
            width: 100%;
            background: rgba(118, 118, 128, .24);
            border: none;
            border-radius: 10px;
            padding: 14px;
            color: var(--text);
            font-size: 16px;
            outline: none;
            font-family: inherit
        }

        .ios-input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: .6
        }

        textarea.ios-input {
            resize: none
        }

        .main-btn {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #fff;
            text-align: center;
            padding: 16px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 17px;
            margin-top: 20px;
            cursor: pointer;
            transition: .2s;
            box-shadow: 0 10px 26px rgba(191, 90, 242, .18);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px
        }

        .main-btn:active {
            transform: scale(.96);
            opacity: .85
        }

        .main-btn.disabled {
            opacity: .45;
            pointer-events: none;
            filter: saturate(.7)
        }

        .btn-spinner {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, .35);
            border-top-color: #fff;
            animation: spin .85s linear infinite;
            display: none
        }

        .main-btn.loading .btn-spinner {
            display: inline-block
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .empty-state {
            text-align: center;
            color: var(--muted);
            margin-top: 40px;
            font-size: 16px;
            animation: fadeIn .5s
        }

        .admin-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px
        }

        .btn-edit {
            flex: 1;
            background: rgba(191, 90, 242, .15);
            color: var(--accent);
            border: 1px solid rgba(191, 90, 242, .30);
            text-align: center;
            padding: 14px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: .2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px
        }

        .btn-edit:active {
            transform: scale(.96);
            opacity: .7
        }

        .btn-delete {
            flex: 1;
            background: rgba(255, 59, 48, .15);
            color: #ff3b30;
            border: 1px solid rgba(255, 59, 48, .3);
            text-align: center;
            padding: 14px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: .2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px
        }

        .btn-delete:active {
            transform: scale(.96);
            opacity: .7
        }

        input[type="file"] {
            display: none !important
        }

        .file-picker-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 13px;
            border-radius: 10px;
            background: rgba(191, 90, 242, .12);
            border: 1.5px dashed rgba(191, 90, 242, .45);
            color: var(--accent);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: .2s
        }

        .file-picker-btn:active {
            transform: scale(.97);
            opacity: .75
        }

        .file-preview-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px
        }

        .file-preview-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(44, 44, 46, .8);
            border-radius: 10px;
            padding: 8px 10px;
            border: 1px solid rgba(84, 84, 88, .4)
        }

        .fp-thumb {
            width: 44px;
            height: 44px;
            border-radius: 7px;
            background: rgba(84, 84, 88, .4);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            overflow: hidden
        }

        .fp-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 7px
        }

        .fp-info {
            flex: 1;
            min-width: 0
        }

        .fp-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .fp-size {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px
        }

        .fp-remove {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: rgba(255, 59, 48, .25);
            color: #ff3b30;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
            cursor: pointer;
            border: 1px solid rgba(255, 59, 48, .35);
            transition: .15s
        }

        .fp-remove:active {
            transform: scale(.85);
            background: rgba(255, 59, 48, .45)
        }

        .att-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, .07);
            cursor: pointer;
            transition: opacity .15s
        }

        .att-row:last-child {
            border-bottom: none;
            padding-bottom: 0
        }

        .att-row:active {
            opacity: .6
        }

        .att-thumb {
            width: 48px;
            height: 48px;
            border-radius: 9px;
            overflow: hidden;
            background: rgba(84, 84, 88, .35);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px
        }

        .att-thumb img,
        .att-thumb video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block
        }

        .att-info {
            flex: 1;
            min-width: 0
        }

        .att-name {
            font-size: 15px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .att-meta {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px
        }

        .att-arr {
            color: var(--muted);
            font-size: 22px;
            font-weight: 300;
            flex-shrink: 0
        }

        .att-row-edit {
            cursor: default
        }

        .att-row-edit:active {
            opacity: 1
        }

        .att-edit-btns {
            display: flex;
            gap: 6px;
            flex-shrink: 0
        }

        .att-btn-replace {
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            background: rgba(191, 90, 242, .15);
            color: var(--accent);
            border: 1px solid rgba(191, 90, 242, .35);
            transition: .15s;
            white-space: nowrap
        }

        .att-btn-replace:active {
            transform: scale(.9);
            opacity: .7
        }

        .att-btn-del {
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            background: rgba(255, 59, 48, .12);
            color: #ff3b30;
            border: 1px solid rgba(255, 59, 48, .3);
            transition: .15s;
            white-space: nowrap
        }

        .att-btn-del:active {
            transform: scale(.9);
            opacity: .7
        }

        .viewer-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s
        }

        .viewer-overlay.open {
            opacity: 1;
            pointer-events: all
        }

        .viewer-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            padding-top: max(12px, env(safe-area-inset-top));
            background: rgba(0, 0, 0, .65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            flex-shrink: 0;
            z-index: 10
        }

        .viewer-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(84, 84, 88, .5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #fff;
            cursor: pointer;
            transition: .15s
        }

        .viewer-close:active {
            transform: scale(.85);
            background: rgba(84, 84, 88, .8)
        }

        .viewer-title {
            font-size: 15px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 55vw;
            text-align: center
        }

        .viewer-dl {
            display: flex;
            align-items: center;
            gap: 7px;
            color: var(--accent);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none
        }

        .viewer-dl:active {
            opacity: .6
        }

        #img-viewer .viewer-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center
        }

        #img-viewer-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transform-origin: center center;
            transition: transform .08s;
            touch-action: none;
            cursor: grab;
            display: block
        }

        #img-viewer-img:active {
            cursor: grabbing
        }

        #pdf-viewer .viewer-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 0;
            touch-action: pan-y pinch-zoom
        }

        .pdf-page-wrap {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            touch-action: pan-y pinch-zoom
        }

        .pdf-page-wrap canvas {
            width: 100% !important;
            height: auto !important;
            display: block
        }

        .pdf-loading {
            color: var(--muted);
            padding: 40px;
            text-align: center;
            font-size: 15px
        }

        /* VIDEO */
        #vid-viewer .viewer-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #000;
            position: relative;
            overflow: hidden
        }

        #vid-viewer-video {
            width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
            outline: none
        }

        #vid-tap-zone {
            position: absolute;
            inset: 0;
            z-index: 5;
            cursor: pointer
        }

        #vid-big-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            /* Ğ±ÑƒĞ»Ğ¾ 72px */
            height: 90px;
            /* Ğ±ÑƒĞ»Ğ¾ 72px */
            border-radius: 50%;
            background: rgba(0, 0, 0, .55);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;

            font-size: 42px;
            /* â¬… Ğ·Ğ±Ñ–Ğ»ÑŒÑˆĞ¸Ğ»Ğ¸ Ñ–ĞºĞ¾Ğ½ĞºÑƒ */
            color: #fff;
            /* â¬… Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾ Ğ±Ñ–Ğ»Ğ¸Ğ¼ */

            pointer-events: none;
            opacity: 0;
            transition: opacity .2s;
            z-index: 6;
        }

        #vid-big-icon svg {
            width: 65px;
            height: 65px;
            fill: #fff;
            /* Ğ°Ğ±Ğ¾ stroke:#fff */
        }

        #vid-big-icon.show {
            opacity: 1
        }

        #vid-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 7;
            background: linear-gradient(transparent, rgba(0, 0, 0, .78));
            padding: 32px 16px 16px;
            transition: opacity .3s
        }


        #vid-controls.hidden {
            opacity: 0;
            pointer-events: none
        }

        .vid-progress-wrap {
            position: relative;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, .25);
            margin-bottom: 12px;
            cursor: pointer
        }

        .vid-progress-fill {
            height: 100%;
            border-radius: 2px;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            pointer-events: none
        }

        .vid-progress-thumb {
            position: absolute;
            top: 50%;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #fff;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 6px rgba(0, 0, 0, .4);
            pointer-events: none
        }

        .vid-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px
        }

        .vid-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: transform .14s, background .14s, opacity .14s;
            flex-shrink: 0;
            border: none;
            outline: none;
            transform: translateZ(0);
            will-change: transform;
        }

        .vid-btn:active {
            transform: scale(.86);
            background: rgba(255, 255, 255, .22)
        }

        .vid-btn svg {
            width: 20px;
            height: 20px;
            fill: #fff;
            opacity: .95;
        }

        .vid-time {
            font-size: 13px;
            color: rgba(255, 255, 255, .85);
            font-weight: 700;
            flex: 1;
            text-align: center;
            letter-spacing: .3px
        }

        .quick-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px
        }

        .quick-chip {
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(118, 118, 128, .22);
            border: 1px solid rgba(84, 84, 88, .35);
            color: rgba(235, 235, 245, .78);
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: transform .16s, opacity .14s, background .2s, border .2s;
            transform: translateZ(0);
            will-change: transform;
        }

        .quick-chip:active {
            transform: scale(.95);
            opacity: .8
        }

        .quick-chip.primary {
            background: rgba(191, 90, 242, .18);
            border: 1px solid rgba(191, 90, 242, .35);
            color: #e9d7ff
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .62);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: opacity .18s
        }

        .loading-overlay.show {
            opacity: 1;
            pointer-events: all
        }

        .loading-card {
            background: rgba(28, 28, 30, .78);
            border: .5px solid rgba(84, 84, 88, .5);
            box-shadow: 0 18px 60px rgba(0, 0, 0, .65);
            border-radius: 18px;
            padding: 18px 16px;
            min-width: 220px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px
        }

        .loading-ring {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 3px solid rgba(191, 90, 242, .28);
            border-top-color: rgba(191, 90, 242, 1);
            animation: spin .85s linear infinite
        }

        .loading-text {
            font-size: 14px;
            font-weight: 700;
            color: rgba(235, 235, 245, .82)
        }

        .loading-sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: -6px
        }

        .svg-ico {
            width: 18px;
            height: 18px;
            display: inline-block
        }

        .svg-ico.big {
            width: 22px;
            height: 22px
        }

        .svg-ico.white {
            fill: #fff
        }

        .svg-ico.accent {
            fill: var(--accent)
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LINK CARDS Ğ¿Ñ–Ğ´ Ğ¾Ğ¿Ğ¸ÑĞ¾Ğ¼ Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #modal-links {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .link-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(44, 44, 46, .85);
            border: 1px solid rgba(84, 84, 88, .5);
            border-radius: 12px;
            padding: 11px 14px;
            cursor: pointer;
            text-decoration: none;
            transition: background .18s, transform .18s;
            -webkit-tap-highlight-color: transparent;
        }

        .link-card:active {
            background: rgba(60, 60, 64, .95);
            transform: scale(.97);
        }

        .link-icon-wrap {
            width: 38px;
            height: 38px;
            border-radius: 9px;
            background: rgba(191, 90, 242, .14);
            border: 1px solid rgba(191, 90, 242, .28);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 20px;
            overflow: hidden;
        }

        .link-favicon {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            object-fit: contain;
        }

        .link-info {
            flex: 1;
            min-width: 0;
        }

        .link-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .link-url {
            font-size: 12px;
            color: var(--accent);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
            font-weight: 500;
        }

        .link-arr {
            color: var(--muted);
            font-size: 20px;
            flex-shrink: 0;
        }


        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           INTRO SCREEN â€” "Ğ’Ñ–Ñ‚Ğ°Ñ"
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @keyframes introBlurIn {
            0% {
                opacity: 0;
                filter: blur(18px);
                transform: scale(1.08);
            }

            100% {
                opacity: 1;
                filter: blur(0px);
                transform: scale(1.0);
            }
        }

        @keyframes introSubIn {
            0% {
                opacity: 0;
                transform: translateY(14px)
            }

            100% {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes introFadeOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(.96);
            }
        }

        #intro-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: rgba(0, 0, 0, .55);
            backdrop-filter: blur(28px);
            -webkit-backdrop-filter: blur(28px);
            pointer-events: none;
        }

        #intro-overlay.out {
            animation: introFadeOut .7s cubic-bezier(.4, 0, .2, 1) forwards;
        }

        #intro-overlay.gone {
            display: none
        }

        .intro-hello {
            font-size: clamp(52px, 14vw, 76px);
            font-weight: 800;
            letter-spacing: -2px;
            background: linear-gradient(135deg, #fff 30%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: introBlurIn 1s cubic-bezier(.4, 0, .2, 1) both;
        }

        .intro-sub {
            font-size: 16px;
            font-weight: 600;
            color: rgba(235, 235, 245, .6);
            letter-spacing: .5px;
            animation: introSubIn .6s .4s cubic-bezier(.4, 0, .2, 1) both;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODAL CONTENT â€” stagger Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @keyframes modalItemIn {
            0% {
                opacity: 0;
                transform: translateY(22px) scale(.97)
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1)
            }
        }

        .modal-content.animating>* {
            opacity: 0;
            animation: modalItemIn .42s cubic-bezier(.25, .8, .2, 1) both;
        }

        .modal-content.animating>*:nth-child(1) {
            animation-delay: .04s
        }

        .modal-content.animating>*:nth-child(2) {
            animation-delay: .11s
        }

        .modal-content.animating>*:nth-child(3) {
            animation-delay: .18s
        }

        .modal-content.animating>*:nth-child(4) {
            animation-delay: .25s
        }

        .modal-content.animating>*:nth-child(5) {
            animation-delay: .32s
        }

        .modal-content.animating>*:nth-child(6) {
            animation-delay: .39s
        }

        .modal-content.animating>*:nth-child(7) {
            animation-delay: .46s
        }

        .modal-content.animating>*:nth-child(8) {
            animation-delay: .53s
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TEXT OVERFLOW FIX
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .modal-desc {
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .modal-block {
            overflow: hidden;
        }

        .hw-short {
            overflow-wrap: break-word;
            word-break: break-word;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ• Ğ—ĞĞ’Ğ”ĞĞĞĞ¯
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .hw-card.important {
            border: 1.5px solid rgba(255, 69, 58, .55);
            background: linear-gradient(135deg,
                rgba(255, 69, 58, .13) 0%,
                rgba(28, 28, 30, .85) 60%);
        }
        .hw-card.important::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 14px;
            background: linear-gradient(135deg,
                rgba(255, 69, 58, .08) 0%,
                transparent 50%);
            pointer-events: none;
        }
        .important-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 700;
            color: #ff453a;
            letter-spacing: .4px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        /* Ğ¢Ğ¾Ğ³Ğ» "Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğµ" Ñƒ Ñ„Ğ¾Ñ€Ğ¼Ñ– */
        .important-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 2px 0;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .important-toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
        }
        .important-toggle-icon {
            font-size: 20px;
            line-height: 1;
        }
        /* iOS-style switch */
        .ios-switch {
            position: relative;
            width: 51px;
            height: 31px;
            flex-shrink: 0;
        }
        .ios-switch input { opacity: 0; width: 0; height: 0; position: absolute }
        .ios-switch-track {
            position: absolute;
            inset: 0;
            border-radius: 999px;
            background: rgba(118,118,128,.32);
            transition: background .25s;
        }
        .ios-switch input:checked ~ .ios-switch-track {
            background: #ff453a;
        }
        .ios-switch-thumb {
            position: absolute;
            top: 2px; left: 2px;
            width: 27px; height: 27px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,.35);
            transition: transform .25s cubic-bezier(.34,1.56,.64,1);
        }
        .ios-switch input:checked ~ .ios-switch-thumb {
            transform: translateX(20px);
        }
        /* Ğ‘ĞµĞ¹Ğ´Ğ¶ Ñƒ Ğ´ĞµÑ‚Ğ°Ğ»ÑÑ… */
        .detail-important-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,69,58,.15);
            border: 1px solid rgba(255,69,58,.4);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 700;
            color: #ff453a;
            letter-spacing: .3px;
            margin-bottom: 14px;
        }

    </style>
</head>

<body>
    <!-- INTRO -->
    <div id="intro-overlay">
        <div class="intro-hello">Ğ’Ñ–Ñ‚Ğ°Ñ</div>
        <div class="intro-sub">Ğ©Ğ¾Ğ´ĞµĞ½Ğ½Ğ¸Ğº ĞšĞ»Ğ°ÑÑƒ ğŸ“š</div>
    </div>

    <!-- GLOBAL LOADING -->
    <div class="loading-overlay" id="loading-overlay" aria-hidden="true">
        <div class="loading-card">
            <div class="loading-ring"></div>
            <div class="loading-text" id="loading-text">Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñâ€¦</div>
            <div class="loading-sub" id="loading-sub">Ğ‘ÑƒĞ´ÑŒ Ğ»Ğ°ÑĞºĞ°, Ğ·Ğ°Ñ‡ĞµĞºĞ°Ğ¹Ñ‚Ğµ</div>
        </div>
    </div>

    <div class="header-container">
        <div class="time-display" id="live-time">--:--</div>
        <div class="date-display" id="live-date">Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
    </div>

    <div class="tabs-wrapper">
        <div class="tab-indicator" id="tab-indicator"></div>
        <div id="tabs-container" style="display:flex;width:100%;position:relative;"></div>
    </div>

    <div id="hw-container">
        <div class="empty-state">Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñâ€¦</div>
    </div>

    <div class="bottom-dock">
        <div class="dock-btn" onclick="openModal('all-hw-modal',()=>renderAllHW('date'))">
            <div class="dock-icon" id="ico-dock-all"></div>
            Ğ’ÑÑ– Ğ”/Ğ—
        </div>

        <div class="dock-fab" onclick="openModal('add-hw-modal',setupAddForm)">+</div>

        <div class="dock-btn" onclick="openModal('schedule-modal',openSchedule)">
            <div class="dock-icon" id="ico-dock-sched"></div>
            Ğ Ğ¾Ğ·ĞºĞ»Ğ°Ğ´
        </div>
    </div>

    <!-- ADD -->
    <div class="modal-overlay" id="add-hw-modal">
        <div class="modal-header">
            <div class="back-btn" onclick="popModal()">ĞĞ°Ğ·Ğ°Ğ´</div>
            <div class="modal-title-center">ĞĞ¾Ğ²Ğµ Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ</div>
            <div style="width:60px;"></div>
        </div>
        <div class="modal-content">

            <div class="modal-block">
                <div class="modal-label">Ğ¯ĞºĞ¸Ğ¹ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚?</div>
                <input id="add-subj-search" class="ios-input" placeholder="ĞŸĞ¾ÑˆÑƒĞº Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ñƒ..." autocomplete="off">
                <div style="height:10px"></div>
                <select id="add-subj" class="ios-input"></select>
            </div>

            <div class="modal-block">
                <div class="modal-label">ĞĞ° ĞºĞ¾Ğ»Ğ¸?</div>
                <input type="date" id="add-date" class="ios-input">
                <div class="quick-row">
                    <div class="quick-chip pressable" onclick="quickSetDate('add','today', this)">Ğ¡ÑŒĞ¾Ğ³Ğ¾Ğ´Ğ½Ñ–</div>
                    <div class="quick-chip pressable" onclick="quickSetDate('add','tomorrow', this)">Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°</div>
                    <div class="quick-chip primary pressable" onclick="quickSetDate('add','nextLesson', this)">ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹
                        ÑƒÑ€Ğ¾Ğº</div>
                </div>
            </div>

            <div class="modal-block">
                <div class="modal-label">Ğ©Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ»Ğ¸?</div>
                <textarea id="add-desc" class="ios-input" rows="5" placeholder="Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚ Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ..."></textarea>
            </div>

            <div class="modal-block">
                <div class="modal-label">Ğ’ĞºĞ»Ğ°Ğ´ĞµĞ½Ğ½Ñ</div>
                <input id="add-files" type="file" multiple
                    accept=".pdf,.png,.jpg,.jpeg,.webp,.mp4,.mov,.avi,.mkv,.doc,.docx,.ppt,.pptx,.txt">
                <div class="file-picker-btn" onclick="document.getElementById('add-files').click()">
                    <span id="ico-clip-add"></span> Ğ’Ğ¸Ğ±Ñ€Ğ°Ñ‚Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¸
                </div>
                <div class="file-preview-list" id="add-files-preview"></div>
            </div>


            <div class="modal-block">
                <div class="important-toggle" onclick="document.getElementById('add-important').click()">
                    <div class="important-toggle-label">
                        <span class="important-toggle-icon">ğŸ”´</span>
                        Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğµ Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ
                    </div>
                    <label class="ios-switch" onclick="event.stopPropagation()">
                        <input type="checkbox" id="add-important">
                        <div class="ios-switch-track"></div>
                        <div class="ios-switch-thumb"></div>
                    </label>
                </div>
            </div>

                        <div class="main-btn" id="btn-add-save" onclick="submitHW()">
                <span class="btn-spinner"></span>
                <span id="ico-save-add"></span>
                Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸
            </div>
        </div>
    </div>

    <!-- DETAIL -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal-header">
            <div class="back-btn" onclick="popModal()">ĞĞ°Ğ·Ğ°Ğ´</div>
            <div style="width:60px;"></div>
        </div>
        <div class="modal-content">
            <div class="modal-subj" id="modal-subj"></div>

            <div id="detail-important-badge" style="display:none;" class="detail-important-badge">ğŸ”´ Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğµ Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ</div>

            <!-- meta row -->
            <div class="detail-meta">
                <div class="chip accent" id="modal-datechip">â€”</div>
                <div class="chip" id="modal-authorchip">â€”</div>
            </div>

            <div class="modal-block">
                <div class="modal-label">Ğ—Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ</div>
                <div class="modal-desc" id="modal-desc"></div>
                <div id="modal-links"></div>
            </div>

            <div class="modal-block">
                <div class="modal-label" style="text-align:center;">Ğ£Ñ€Ğ¾Ğº Ğ·Ğ° Ñ€Ğ¾Ğ·ĞºĞ»Ğ°Ğ´Ğ¾Ğ¼</div>
                <div class="week-pills" id="week-pills"></div>
            </div>

            <div class="modal-block" id="attachments-block" style="display:none;">
                <div class="modal-label">Ğ’ĞºĞ»Ğ°Ğ´ĞµĞ½Ğ½Ñ</div>
                <div id="attachments-list"></div>
            </div>

            <div class="admin-actions" id="admin-actions" style="display:none;">
                <div class="btn-edit" onclick="openEditModal()"><span id="ico-edit"></span>Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸</div>
                <div class="btn-delete" id="btn-del" onclick="confirmDelete()"><span id="ico-trash"></span>Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT -->
    <div class="modal-overlay" id="edit-hw-modal">
        <div class="modal-header">
            <div class="back-btn" onclick="popModal()">ĞĞ°Ğ·Ğ°Ğ´</div>
            <div class="modal-title-center">Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ</div>
            <div style="width:60px;"></div>
        </div>
        <div class="modal-content">

            <div class="modal-block">
                <div class="modal-label">ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚</div>
                <input id="edit-subj-search" class="ios-input" placeholder="ĞŸĞ¾ÑˆÑƒĞº Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ñƒ..." autocomplete="off">
                <div style="height:10px"></div>
                <select id="edit-subj" class="ios-input"></select>
            </div>

            <div class="modal-block">
                <div class="modal-label">Ğ”Ğ°Ñ‚Ğ°</div>
                <input type="date" id="edit-date" class="ios-input">
                <div class="quick-row">
                    <div class="quick-chip pressable" onclick="quickSetDate('edit','today', this)">Ğ¡ÑŒĞ¾Ğ³Ğ¾Ğ´Ğ½Ñ–</div>
                    <div class="quick-chip pressable" onclick="quickSetDate('edit','tomorrow', this)">Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°</div>
                    <div class="quick-chip primary pressable" onclick="quickSetDate('edit','nextLesson', this)">
                        ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹ ÑƒÑ€Ğ¾Ğº</div>
                </div>
            </div>

            <div class="modal-block">
                <div class="modal-label">Ğ—Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ</div>
                <textarea id="edit-desc" class="ios-input" rows="5"></textarea>
            </div>

            <div class="modal-block">
                <div class="modal-label">Ğ’ĞºĞ»Ğ°Ğ´ĞµĞ½Ğ½Ñ</div>
                <div id="edit-att-list"></div>
                <input id="edit-files" type="file" multiple
                    accept=".pdf,.png,.jpg,.jpeg,.webp,.mp4,.mov,.avi,.mkv,.doc,.docx,.ppt,.pptx,.txt">
                <input id="replace-file-input" type="file"
                    accept=".pdf,.png,.jpg,.jpeg,.webp,.mp4,.mov,.avi,.mkv,.doc,.docx,.ppt,.pptx,.txt">
                <div class="file-picker-btn" style="margin-top:10px"
                    onclick="document.getElementById('edit-files').click()">
                    <span id="ico-plus-file"></span> Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¸
                </div>
                <div class="file-preview-list" id="edit-files-preview"></div>
            </div>


            <div class="modal-block">
                <div class="important-toggle" onclick="document.getElementById('edit-important').click()">
                    <div class="important-toggle-label">
                        <span class="important-toggle-icon">ğŸ”´</span>
                        Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğµ Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ
                    </div>
                    <label class="ios-switch" onclick="event.stopPropagation()">
                        <input type="checkbox" id="edit-important">
                        <div class="ios-switch-track"></div>
                        <div class="ios-switch-thumb"></div>
                    </label>
                </div>
            </div>

                        <div class="main-btn" id="btn-edit-save" onclick="submitEdit()">
                <span class="btn-spinner"></span>
                <span id="ico-save-edit"></span>
                Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸
            </div>
        </div>
    </div>

    <!-- ALL HW -->
    <div class="modal-overlay" id="all-hw-modal">
        <div class="modal-header">
            <div class="back-btn" onclick="popModal()">ĞĞ°Ğ·Ğ°Ğ´</div>
            <div class="modal-title-center">Ğ’ÑÑ– Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ</div>
            <div style="width:60px;"></div>
        </div>
        <div class="modal-content">
            <div class="tabs-wrapper" style="margin-bottom:16px;">
                <div class="tab-indicator" id="all-hw-indicator"></div>
                <div style="display:flex;width:100%;position:relative;">
                    <div class="tab active pressable" id="tab-sort-date" onclick="selectAllMode('date', this)">Ğ—Ğ° Ğ´Ğ°Ñ‚Ğ¾Ñ
                    </div>
                    <div class="tab pressable" id="tab-sort-subj" onclick="selectAllMode('subject', this)">Ğ—Ğ° Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ¾Ğ¼
                    </div>
                </div>
            </div>
            <div class="filter-scroll" id="all-hw-filters"></div>
            <div id="all-hw-list"></div>
        </div>
    </div>

    <!-- SCHEDULE -->
    <div class="modal-overlay" id="schedule-modal">
        <div class="modal-header">
            <div class="back-btn" onclick="popModal()">ĞĞ°Ğ·Ğ°Ğ´</div>
            <div class="modal-title-center">Ğ Ğ¾Ğ·ĞºĞ»Ğ°Ğ´</div>
            <div style="width:60px;"></div>
        </div>
        <div class="modal-content">
            <div class="filter-scroll" id="sched-tabs"></div>
            <div id="schedule-list"></div>
        </div>
    </div>

    <!-- IMAGE VIEWER -->
    <div class="viewer-overlay" id="img-viewer">
        <div class="viewer-bar">
            <div class="viewer-close" onclick="closeViewer('img-viewer')">âœ•</div>
            <div class="viewer-title" id="img-viewer-title"></div>
            <a class="viewer-dl" id="img-viewer-dl" download>
                <span id="ico-download-img"></span>Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸
            </a>
        </div>
        <div class="viewer-body"><img id="img-viewer-img" src="" alt=""></div>
    </div>

    <!-- VIDEO VIEWER -->
    <div class="viewer-overlay" id="vid-viewer">
        <div class="viewer-bar">
            <div class="viewer-close" onclick="closeViewer('vid-viewer')">âœ•</div>
            <div class="viewer-title" id="vid-viewer-title"></div>
            <a class="viewer-dl" id="vid-viewer-dl" download>
                <span id="ico-download-vid"></span>Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸
            </a>
        </div>
        <div class="viewer-body">
            <video id="vid-viewer-video" playsinline preload="metadata"></video>
            <div id="vid-tap-zone"></div>
            <div id="vid-big-icon"></div>
            <div id="vid-controls">
                <div class="vid-progress-wrap" id="vid-progress-wrap">
                    <div class="vid-progress-fill" id="vid-progress-fill" style="width:0%"></div>
                    <div class="vid-progress-thumb" id="vid-progress-thumb" style="left:0%"></div>
                </div>
                <div class="vid-row">
                    <button class="vid-btn" id="vid-play-btn" onclick="vidTogglePlay()"
                        aria-label="Play/Pause"></button>
                    <div class="vid-time" id="vid-time">0:00 / 0:00</div>
                    <button class="vid-btn" id="vid-mute-btn" onclick="vidToggleMute()" aria-label="Mute"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF VIEWER -->
    <div class="viewer-overlay" id="pdf-viewer">
        <div class="viewer-bar">
            <div class="viewer-close" onclick="closeViewer('pdf-viewer')">âœ•</div>
            <div class="viewer-title" id="pdf-viewer-title"></div>
            <a class="viewer-dl" id="pdf-viewer-dl" download>
                <span id="ico-download-pdf"></span>Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸
            </a>
        </div>
        <div class="viewer-body" id="pdf-viewer-body">
            <div class="pdf-loading">Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ PDFâ€¦</div>
        </div>
    </div>

    <script>
        if (typeof pdfjsLib !== 'undefined') pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const tg = window.Telegram.WebApp;
        tg.expand(); tg.ready();
        tg.setHeaderColor('#000000'); tg.setBackgroundColor('#000000');

        const ADMIN_ID = 5360495885,
            currentUserId = tg.initDataUnsafe?.user?.id ?? null,
            isAdmin = currentUserId === ADMIN_ID;

        let currentTask = null;

        function escapeHTML(s) {
            return String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", "&#039;")
        }

        function playVibration(style) {
            const isAnd = tg.platform === 'android' || tg.platform === 'android_x';
            if (isAnd && "vibrate" in navigator) navigator.vibrate(style === 'heavy' ? 45 : style === 'medium' ? 25 : style === 'light' ? 12 : 8);
            else {
                try { tg.HapticFeedback.impactOccurred(style) }
                catch { try { tg.HapticFeedback.impactOccurred('light') } catch { } }
            }
        }

        // ========= ĞŸĞ›ĞĞ’ĞĞ˜Ğ™ ĞĞĞ¢Ğ˜Ğ¡Ğš (Ğ±ĞµĞ· keyframes) =========
        const PressFX = {
            last: new WeakMap(),
            down(el) {
                if (!el) return;
                el.classList.add('is-pressed');
            },
            up(el) {
                if (!el) return;
                el.classList.remove('is-pressed');
            },
            tap(el, cooldown = 90) {
                if (!el) return true;
                const now = performance.now();
                const last = PressFX.last.get(el) || 0;
                if (now - last < cooldown) return false; // Ğ°Ğ½Ñ‚Ğ¸-ÑĞ¿Ğ°Ğ¼ ÑĞ°Ğ¼Ğµ Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ—
                PressFX.last.set(el, now);
                PressFX.down(el);
                setTimeout(() => PressFX.up(el), 120);
                return true;
            }
        };

        // ========= ICONS (inline SVG) =========
        const ICONS = {
            book: `<svg class="svg-ico big white" viewBox="0 0 24 24" fill="none"><path d="M4 19.5c0-1.1.9-2 2-2h14" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M6 3h14v16H6c-1.1 0-2 .9-2 2V5c0-1.1.9-2 2-2z" stroke="white" stroke-width="2" stroke-linejoin="round"/></svg>`,
            cal: `<svg class="svg-ico big white" viewBox="0 0 24 24" fill="none"><path d="M7 3v3M17 3v3" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M4 8h16" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M6 5h12a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2z" stroke="white" stroke-width="2"/></svg>`,
            clip: `<svg class="svg-ico accent" viewBox="0 0 24 24" fill="none"><path d="M8 12.5l6.8-6.8a3 3 0 114.2 4.2l-8.5 8.5a5 5 0 01-7.1-7.1l8.1-8.1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            save: `<svg class="svg-ico white" viewBox="0 0 24 24" fill="none"><path d="M5 21h14a2 2 0 0 0 2-2V8l-4-4H5a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2z" stroke="white" stroke-width="2"/><path d="M7 21v-8h10v8" stroke="white" stroke-width="2"/><path d="M8 4v4h8" stroke="white" stroke-width="2"/></svg>`,
            edit: `<svg class="svg-ico accent" viewBox="0 0 24 24" fill="none"><path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/></svg>`,
            trash: `<svg class="svg-ico" style="fill:#ff3b30" viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="#ff3b30" stroke-width="2" stroke-linecap="round"/><path d="M8 6V4h8v2" stroke="#ff3b30" stroke-width="2" stroke-linecap="round"/><path d="M6 6l1 16h10l1-16" stroke="#ff3b30" stroke-width="2" stroke-linejoin="round"/><path d="M10 11v6M14 11v6" stroke="#ff3b30" stroke-width="2" stroke-linecap="round"/></svg>`,
            plus: `<svg class="svg-ico accent" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,
            download: `<svg class="svg-ico accent" viewBox="0 0 24 24" fill="none"><path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M8 11l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 21h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`,

            // VIDEO PLAYER ICONS
            play: `<svg viewBox="0 0 24 24"><path d="M8 5v14l12-7-12-7z"/></svg>`,
            pause: `<svg viewBox="0 0 24 24"><path d="M6 5h5v14H6zM13 5h5v14h-5z"/></svg>`,
            vol: `<svg viewBox="0 0 24 24"><path d="M3 10v4h4l5 4V6L7 10H3z"/><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03z"/><path d="M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`,
            mute: `<svg viewBox="0 0 24 24"><path d="M3 10v4h4l5 4V6L7 10H3z"/><path d="M16 9l5 5"/><path d="M21 9l-5 5"/></svg>`,
            bigPlay: `<svg viewBox="0 0 24 24"><path d="M8 5v14l12-7-12-7z"/></svg>`,
            bigPause: `<svg viewBox="0 0 24 24"><path d="M6 5h5v14H6zM13 5h5v14h-5z"/></svg>`
        };

        function mountIcon(id, svg) { const el = document.getElementById(id); if (el) el.innerHTML = svg }
        mountIcon('ico-dock-all', ICONS.book);
        mountIcon('ico-dock-sched', ICONS.cal);
        mountIcon('ico-clip-add', ICONS.clip);
        mountIcon('ico-save-add', ICONS.save);
        mountIcon('ico-save-edit', ICONS.save);
        mountIcon('ico-edit', ICONS.edit);
        mountIcon('ico-trash', ICONS.trash);
        mountIcon('ico-plus-file', ICONS.plus);
        mountIcon('ico-download-img', ICONS.download);
        mountIcon('ico-download-vid', ICONS.download);
        mountIcon('ico-download-pdf', ICONS.download);

        // ========= LOADING + ANTI DOUBLE TAP =========
        const LO = {
            el: document.getElementById('loading-overlay'),
            t: document.getElementById('loading-text'),
            s: document.getElementById('loading-sub')
        };

        function showLoading(title = "Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñâ€¦", sub = "Ğ‘ÑƒĞ´ÑŒ Ğ»Ğ°ÑĞºĞ°, Ğ·Ğ°Ñ‡ĞµĞºĞ°Ğ¹Ñ‚Ğµ") {
            LO.t.textContent = title; LO.s.textContent = sub;
            LO.el.classList.add('show');
        }
        function hideLoading() { LO.el.classList.remove('show') }

        function setBtnState(btn, { loading = false, disabled = false }) {
            if (!btn) return;
            btn.classList.toggle('loading', !!loading);
            btn.classList.toggle('disabled', !!disabled);
        }

        async function runGuard(key, fn, { overlayTitle = "Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñâ€¦", overlaySub = "Ğ‘ÑƒĞ´ÑŒ Ğ»Ğ°ÑĞºĞ°, Ğ·Ğ°Ñ‡ĞµĞºĞ°Ğ¹Ñ‚Ğµ", btn = null, useOverlay = true } = {}) {
            if (runGuard._busy[key]) return;
            runGuard._busy[key] = true;
            try {
                if (btn) setBtnState(btn, { loading: true, disabled: true });
                if (useOverlay) showLoading(overlayTitle, overlaySub);
                return await fn();
            } finally {
                if (useOverlay) hideLoading();
                if (btn) setBtnState(btn, { loading: false, disabled: false });
                runGuard._busy[key] = false;
            }
        }
        runGuard._busy = {};

        // ========= DATA =========
        const SCHEDULE = {
            "ĞŸĞ¾Ğ½ĞµĞ´Ñ–Ğ»Ğ¾Ğº": ["ĞĞ»Ğ³ĞµĞ±Ñ€Ğ°", "Ğ¤Ñ–Ğ·Ğ¸ĞºĞ°", "Ğ†Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸ĞºĞ°", "Ğ¤Ñ–Ğ·ĞºÑƒĞ»ÑŒÑ‚ÑƒÑ€Ğ°", "ĞĞ½Ğ³Ğ». ĞœĞ¾Ğ²Ğ°", "Ğ‘Ñ–Ğ¾Ğ»Ğ¾Ğ³Ñ–Ñ", "Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ñ–Ñ—"],
            "Ğ’Ñ–Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğº": ["Ğ¥Ñ–Ğ¼Ñ–Ñ", "Ğ“ĞµĞ¾Ğ¼ĞµÑ‚Ñ€Ñ–Ñ", "Ğ£ĞºÑ€. ĞœĞ¾Ğ²Ğ°", "Ğ£ĞºÑ€. Ğ›Ñ–Ñ‚", "Ğ¤Ñ–Ğ·ĞºÑƒĞ»ÑŒÑ‚ÑƒÑ€Ğ°", "Ğ¤Ñ–Ğ·Ğ¸ĞºĞ°"],
            "Ğ¡ĞµÑ€ĞµĞ´Ğ°": ["Ğ£ĞºÑ€. ĞœĞ¾Ğ²Ğ°", "ĞœĞ¸ÑÑ‚ĞµÑ†Ñ‚Ğ²Ğ¾", "Ğ£ĞºÑ€. Ğ›Ñ–Ñ‚", "Ğ¤Ñ–Ğ·Ğ¸ĞºĞ°", "Ğ“ĞµĞ¾Ğ³Ñ€Ğ°Ñ„Ñ–Ñ", "ĞœĞ¸ÑÑ‚ĞµÑ†Ñ‚Ğ²Ğ¾ (0.5)"],
            "Ğ§ĞµÑ‚Ğ²ĞµÑ€": ["Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ", "ĞĞ»Ğ³ĞµĞ±Ñ€Ğ°", "Ğ¥Ñ–Ğ¼Ñ–Ñ", "Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ£ĞºÑ€Ğ°Ñ—Ğ½Ğ¸", "Ğ‘Ñ–Ğ¾Ğ»Ğ¾Ğ³Ñ–Ñ", "Ğ†Ğ½Ñ„Ğ¾Ñ€Ğ¼./Ğ¢ĞµÑ…Ğ½Ğ¾Ğ».", "ĞĞ½Ğ³Ğ». ĞœĞ¾Ğ²Ğ°"],
            "ĞŸ'ÑÑ‚Ğ½Ğ¸Ñ†Ñ": ["Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ£ĞºÑ€Ğ°Ñ—Ğ½Ğ¸", "Ğ—Ğ°Ñ€. Ğ›Ñ–Ñ‚", "ĞÑÑ‚Ñ€Ğ¾Ğ½Ğ¾Ğ¼Ñ–Ñ", "Ğ£ĞºÑ€. ĞœĞ¾Ğ²Ğ° (Ğ´Ğ¾Ğ´)", "Ğ¤Ñ–Ğ·ĞºÑƒĞ»ÑŒÑ‚ÑƒÑ€Ğ°"]
        };

        const BELLS = [
            { num: 1, s: "09:00", e: "09:45" },
            { num: 2, s: "09:55", e: "10:40" },
            { num: 3, s: "10:50", e: "11:35" },
            { num: 4, s: "11:45", e: "12:30" },
            { num: 0, s: "12:30", e: "13:00", isBreak: true },
            { num: 5, s: "13:00", e: "13:45" },
            { num: 6, s: "13:55", e: "14:40" },
            { num: 7, s: "14:50", e: "15:35" },
            { num: 8, s: "15:45", e: "16:30" }
        ];

        const DAYS_SHORT = ["ĞŸĞ½", "Ğ’Ñ‚", "Ğ¡Ñ€", "Ğ§Ñ‚", "ĞŸÑ‚"],
            DAYS_FULL = ["ĞŸĞ¾Ğ½ĞµĞ´Ñ–Ğ»Ğ¾Ğº", "Ğ’Ñ–Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğº", "Ğ¡ĞµÑ€ĞµĞ´Ğ°", "Ğ§ĞµÑ‚Ğ²ĞµÑ€", "ĞŸ'ÑÑ‚Ğ½Ğ¸Ñ†Ñ"];

        const ALL_SUBJECTS = [...new Set(Object.values(SCHEDULE).flat())].sort();

        // ========= CLOCK =========
        function updateClock() {
            const now = new Date();
            document.getElementById('live-time').innerText = now.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
            let ds = now.toLocaleDateString('uk-UA', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('live-date').innerText = ds.charAt(0).toUpperCase() + ds.slice(1);
        }
        setInterval(updateClock, 1000); updateClock();

        // ========= DATE HELPERS =========
        function localISO(d = new Date()) {
            const x = new Date(d);
            x.setHours(0, 0, 0, 0);
            const y = x.getFullYear();
            const m = String(x.getMonth() + 1).padStart(2, '0');
            const day = String(x.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }
        function addDaysISO(baseISO, days) {
            const [y, m, d] = baseISO.split('-').map(Number);
            const dt = new Date(y, m - 1, d);
            dt.setDate(dt.getDate() + days);
            return localISO(dt);
        }
        function subDaysISO(baseISO, days) {
            return addDaysISO(baseISO, -days);
        }
        function prettyDate(iso) {
            if (!iso) return "â€”";
            const d = new Date(iso + "T00:00:00");
            return d.toLocaleDateString('uk-UA', { day: 'numeric', month: 'long' });
        }

        function isCurrentLesson(b, d) {
            const now = new Date(), di = now.getDay() - 1;
            if (di < 0 || di > 4 || DAYS_FULL[di] !== d) return false;
            const [sh, sm] = b.s.split(':').map(Number), [eh, em] = b.e.split(':').map(Number), cm = now.getHours() * 60 + now.getMinutes();
            return cm >= (sh * 60 + sm) && cm <= (eh * 60 + em);
        }

        function getCurrentSubject() {
            const now = new Date(), di = now.getDay() - 1;
            if (di < 0 || di > 4) return null;
            const dn = DAYS_FULL[di], sub = SCHEDULE[dn] || [];
            let li = 0;
            for (const b of BELLS) {
                if (b.isBreak) continue;
                if (li < sub.length) {
                    if (isCurrentLesson(b, dn)) return sub[li];
                    li++;
                }
            }
            return null;
        }

        function getNextDateForSubject(subj) {
            const now = new Date();
            const todayISO = localISO(now);
            for (let i = 0; i <= 7; i++) {
                const d = new Date(now); d.setDate(d.getDate() + i);
                const di = d.getDay() - 1;
                if (di >= 0 && di <= 4 && (SCHEDULE[DAYS_FULL[di]] || []).includes(subj)) {
                    if (i === 0) {
                        const last = BELLS.filter(b => !b.isBreak).slice(-1)[0];
                        const [lh, lm] = last.e.split(':').map(Number);
                        const after = (now.getHours() * 60 + now.getMinutes()) > (lh * 60 + lm);
                        if (after) continue;
                    }
                    return localISO(d);
                }
            }
            return addDaysISO(todayISO, 1);
        }

        // ========= SUBJECT SEARCH FILTER =========
        function applySubjectSearch(inputId, selectId) {
            const inp = document.getElementById(inputId);
            const sel = document.getElementById(selectId);
            if (!inp || !sel) return;
            let full = [...ALL_SUBJECTS];

            function rebuild(filter = "") {
                const cur = sel.value;
                const q = filter.trim().toLowerCase();
                const list = q ? full.filter(s => s.toLowerCase().includes(q)) : full;
                sel.innerHTML = '';
                list.forEach(s => {
                    const o = document.createElement('option');
                    o.value = s; o.innerText = s;
                    sel.appendChild(o);
                });
                if (list.includes(cur)) sel.value = cur;
            }
            inp.addEventListener('input', () => rebuild(inp.value));
            rebuild("");
        }

        // ========= QUICK DATE (Ğ°Ğ½Ñ‚Ğ¸-ÑĞ¿Ğ°Ğ¼ + Ğ±ĞµĞ· "Ğ´ÑŒĞ¾Ñ€Ğ³Ñƒ") =========
        let addDateTouched = false, editDateTouched = false;
        const quickLock = { add: 0, edit: 0 };

        function quickSetDate(form, mode, el = null) {
            // Ğ°Ğ½Ñ‚Ğ¸-ÑĞ¿Ğ°Ğ¼ (Ğ»Ğ¾Ğ³Ñ–Ñ‡Ğ½Ğ¸Ğ¹): Ğ½Ğµ Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ‚Ñ€Ğ¸Ğ³ĞµÑ€Ğ¸Ñ‚Ğ¸ 60 Ñ€Ğ°Ğ·/ÑĞµĞº
            const now = performance.now();
            if (now - quickLock[form] < 90) return;
            quickLock[form] = now;

            if (el) PressFX.tap(el, 60);
            playVibration('light');

            const sel = document.getElementById(form === 'add' ? 'add-subj' : 'edit-subj');
            const dateEl = document.getElementById(form === 'add' ? 'add-date' : 'edit-date');
            const subj = sel?.value;

            const prev = dateEl.value;

            let next = prev;
            if (mode === 'today') next = localISO(new Date());
            else if (mode === 'tomorrow') next = addDaysISO(localISO(new Date()), 1);
            else if (mode === 'nextLesson' && subj) next = getNextDateForSubject(subj);

            if (next && next !== prev) dateEl.value = next;

            if (form === 'add') addDateTouched = true;
            else editDateTouched = true;
        }

        // ========= MODALS =========
        let hwData = {}, allHWData = [], tabKeys = [], currentMainDateKey = null, didFirstLoad = false, isFetching = false;
        let newlyAddedIds = new Set(), lastTabsSig = "", lastAllSig = "";
        let modalStack = [];

        function openModal(id, cb = null) {
            playVibration('heavy');
            if (cb) cb();
            const overlay = document.getElementById(id);
            overlay.classList.add('open');
            // stagger Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ Ğ²Ğ¼Ñ–ÑÑ‚Ñƒ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ¸
            const mc = overlay.querySelector('.modal-content');
            if (mc) {
                mc.classList.remove('animating');
                void mc.offsetWidth; // force reflow â€” Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ—
                mc.classList.add('animating');
                mc._animTimer && clearTimeout(mc._animTimer);
                mc._animTimer = setTimeout(() => mc.classList.remove('animating'), 900);
            }
            modalStack.push(id);
            tg.BackButton.show()
        }

        function popModal() {
            if (!modalStack.length) return;
            playVibration('soft');
            const id = modalStack.pop();
            document.getElementById(id).classList.remove('open');
            if (modalStack.length) tg.BackButton.show(); else tg.BackButton.hide()
        }

        function closeModalById(id) {
            document.getElementById(id).classList.remove('open');
            const i = modalStack.lastIndexOf(id);
            if (i !== -1) modalStack.splice(i, 1);
            if (!modalStack.length) tg.BackButton.hide()
        }

        tg.BackButton.onClick(() => popModal());

        // === IMAGE VIEWER ===
        let imgScale = 1, imgX = 0, imgY = 0, imgLastDist = null, imgPinchSS = 1, imgDragStart = null, imgDragO = null, imgLastTap = 0;
        const imgEl = document.getElementById('img-viewer-img');

        function openImageViewer(url, name) {
            document.getElementById('img-viewer-title').innerText = name || '';
            const dl = document.getElementById('img-viewer-dl');
            dl.href = url; dl.download = name || 'image';
            imgEl.src = url; imgScale = 1; imgX = 0; imgY = 0;
            applyImgT();
            document.getElementById('img-viewer').classList.add('open');
        }
        function applyImgT() { imgEl.style.transform = `translate(${imgX}px,${imgY}px) scale(${imgScale})` }
        function clampImg() { const mp = Math.max(0, (imgScale - 1) * 200); imgX = Math.max(-mp, Math.min(mp, imgX)); imgY = Math.max(-mp, Math.min(mp, imgY)) }

        imgEl.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                imgLastDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                imgPinchSS = imgScale
            } else if (e.touches.length === 1) {
                imgDragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                imgDragO = { x: imgX, y: imgY }
            }
        }, { passive: true });

        imgEl.addEventListener('touchmove', e => {
            e.preventDefault();
            if (e.touches.length === 2 && imgLastDist !== null) {
                const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                imgScale = Math.max(1, Math.min(8, imgPinchSS * (d / imgLastDist)));
                clampImg(); applyImgT()
            } else if (e.touches.length === 1 && imgDragStart && imgScale > 1) {
                imgX = imgDragO.x + (e.touches[0].clientX - imgDragStart.x);
                imgY = imgDragO.y + (e.touches[0].clientY - imgDragStart.y);
                clampImg(); applyImgT()
            }
        }, { passive: false });

        imgEl.addEventListener('touchend', e => {
            if (e.touches.length < 2) imgLastDist = null;
            if (e.touches.length === 0) {
                imgDragStart = null;
                if (imgScale < 1.05) { imgScale = 1; imgX = 0; imgY = 0; applyImgT() }
            }
        }, { passive: true });

        document.getElementById('img-viewer').querySelector('.viewer-body')
            .addEventListener('wheel', e => {
                e.preventDefault();
                imgScale = Math.max(1, Math.min(8, imgScale * (e.deltaY < 0 ? 1.12 : 0.89)));
                clampImg(); applyImgT()
            }, { passive: false });

        imgEl.addEventListener('click', () => {
            const n = Date.now();
            if (n - imgLastTap < 300) { imgScale = 1; imgX = 0; imgY = 0; applyImgT() }
            imgLastTap = n
        });

        // === CUSTOM VIDEO PLAYER (SVG) ===
        const vidEl = document.getElementById('vid-viewer-video');
        const vidPlayBtn = document.getElementById('vid-play-btn'),
            vidMuteBtn = document.getElementById('vid-mute-btn');

        const vidTimeEl = document.getElementById('vid-time'),
            vidFill = document.getElementById('vid-progress-fill');

        const vidThumb = document.getElementById('vid-progress-thumb'),
            vidWrap = document.getElementById('vid-progress-wrap');

        const vidBigIcon = document.getElementById('vid-big-icon'),
            vidControls = document.getElementById('vid-controls');

        let vidTimer = null;

        function fmtT(s) { const m = Math.floor(s / 60); return `${m}:${String(Math.floor(s % 60)).padStart(2, '0')}` }

        function vidSetPlayIcon(paused) {
            vidPlayBtn.innerHTML = paused ? ICONS.play : ICONS.pause;
            vidBigIcon.innerHTML = paused ? ICONS.bigPlay : ICONS.bigPause;
        }

        function vidSetMuteIcon(muted) {
            // mute icon Ğ·Ñ€Ğ¾Ğ±Ğ¸Ğ² "Ğ¿ĞµÑ€ĞµĞºÑ€ĞµÑĞ»ĞµĞ½Ğ¸Ğ¼" â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ğ´Ğ²Ğ¾Ğ¼Ğ° Ğ»Ñ–Ğ½Ñ–ÑĞ¼Ğ¸
            // Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ¼Ğ¾Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ¸ÑÑŒ Ñ–Ğ· stroke, Ğ·Ğ°Ğ»Ğ¸ÑˆĞ°Ñ ÑĞº svg path (Ğ¿Ñ€Ğ°Ñ†ÑÑ” Ğ² Ğ±Ñ–Ğ»ÑŒÑˆĞ¾ÑÑ‚Ñ– Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ñ–Ğ²)
            vidMuteBtn.innerHTML = muted
                ? `<svg viewBox="0 0 24 24"><path fill="#fff" d="M3 10v4h4l5 4V6L7 10H3z"/><path fill="#fff" d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03z"/><path fill="#fff" d="M19 5l-14 14" /></svg>`
                : ICONS.vol;
        }

        function vidShowCtrls() {
            vidControls.classList.remove('hidden');
            clearTimeout(vidTimer);
            if (!vidEl.paused) vidTimer = setTimeout(() => vidControls.classList.add('hidden'), 3000)
        }

        function vidUpdProg() {
            if (!vidEl.duration) return;
            const p = (vidEl.currentTime / vidEl.duration) * 100;
            vidFill.style.width = p + '%';
            vidThumb.style.left = p + '%';
            vidTimeEl.textContent = fmtT(vidEl.currentTime) + ' / ' + fmtT(vidEl.duration)
        }

        function vidTogglePlay() {
            if (vidEl.paused) {
                vidEl.play().catch(() => { });
            } else {
                vidEl.pause();
            }
            // Ñ–ĞºĞ¾Ğ½ĞºĞ¸ Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒÑÑ Ñ‡ĞµÑ€ĞµĞ· play/pause events
            vidBigIcon.classList.add('show');
            setTimeout(() => vidBigIcon.classList.remove('show'), 520);
            vidShowCtrls();
        }

        function vidToggleMute() {
            vidEl.muted = !vidEl.muted;
            vidSetMuteIcon(vidEl.muted);
            vidShowCtrls();
        }

        vidEl.addEventListener('timeupdate', vidUpdProg);
        vidEl.addEventListener('play', () => { vidSetPlayIcon(false); vidShowCtrls() });
        vidEl.addEventListener('pause', () => { vidSetPlayIcon(true); vidControls.classList.remove('hidden'); clearTimeout(vidTimer) });
        vidEl.addEventListener('ended', () => { vidSetPlayIcon(true); vidControls.classList.remove('hidden') });
        vidEl.addEventListener('loadedmetadata', () => { vidTimeEl.textContent = '0:00 / ' + fmtT(vidEl.duration) });

        document.getElementById('vid-tap-zone').addEventListener('click', vidTogglePlay);

        function vidSeek(e) {
            const r = vidWrap.getBoundingClientRect();
            const p = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width));
            vidEl.currentTime = p * vidEl.duration;
            vidShowCtrls();
        }
        vidWrap.addEventListener('click', vidSeek);

        let vidSeeking = false;
        vidWrap.addEventListener('touchstart', e => { vidSeeking = true; vidSeek(e.touches[0]) }, { passive: true });
        vidWrap.addEventListener('touchmove', e => { if (vidSeeking) { e.preventDefault(); vidSeek(e.touches[0]) } }, { passive: false });
        vidWrap.addEventListener('touchend', () => { vidSeeking = false }, { passive: true });

        function openVideoViewer(url, name) {
            document.getElementById('vid-viewer-title').innerText = name || '';
            const dl = document.getElementById('vid-viewer-dl');
            dl.href = url; dl.download = name || 'video';

            vidEl.src = url;
            vidEl.muted = false;

            vidFill.style.width = '0%'; vidThumb.style.left = '0%';
            vidTimeEl.textContent = '0:00 / 0:00';
            vidControls.classList.remove('hidden');

            vidSetPlayIcon(true);
            vidSetMuteIcon(false);

            vidEl.load();
            document.getElementById('vid-viewer').classList.add('open');

            setTimeout(() => { vidEl.play().catch(() => { }); vidShowCtrls() }, 150);
        }

        function closeViewer(id) {
            document.getElementById(id).classList.remove('open');
            if (id === 'vid-viewer') { clearTimeout(vidTimer); vidEl.pause(); vidEl.src = '' }
        }

        // === PDF VIEWER ===
        let pdfPD = null, pdfPS = 1, pdfBS = 1;
        const pdfBody = document.getElementById('pdf-viewer-body');

        function openPdfViewer(url, name) {
            document.getElementById('pdf-viewer-title').innerText = name || 'document.pdf';
            const dl = document.getElementById('pdf-viewer-dl');
            dl.href = url; dl.download = name || 'document.pdf';
            pdfBody.innerHTML = '<div class="pdf-loading">Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ PDFâ€¦</div>';
            document.getElementById('pdf-viewer').classList.add('open');
            renderPDF(url);
        }

        async function renderPDF(url) {
            if (typeof pdfjsLib === 'undefined') { pdfBody.innerHTML = '<div class="pdf-loading">PDF.js Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ¾</div>'; return }
            try {
                const pdf = await pdfjsLib.getDocument(url).promise;
                pdfBody.innerHTML = '';
                pdfBS = 1; pdfPS = 1;
                for (let n = 1; n <= pdf.numPages; n++) {
                    const page = await pdf.getPage(n);
                    const vp = page.getViewport({ scale: 2.0 });
                    const wrap = document.createElement('div');
                    wrap.className = 'pdf-page-wrap';
                    const cv = document.createElement('canvas');
                    cv.width = vp.width; cv.height = vp.height;
                    await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
                    wrap.appendChild(cv);
                    pdfBody.appendChild(wrap);
                }
                pdfBody.addEventListener('touchstart', e => {
                    if (e.touches.length === 2) {
                        pdfPD = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                        pdfPS = pdfBS
                    }
                }, { passive: true });

                pdfBody.addEventListener('touchmove', e => {
                    if (e.touches.length !== 2 || pdfPD === null) return;
                    e.preventDefault();
                    const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    pdfBS = Math.max(.8, Math.min(4, pdfPS * (d / pdfPD)));
                    pdfBody.querySelectorAll('.pdf-page-wrap').forEach(w => {
                        w.style.transform = `scale(${pdfBS})`;
                        w.style.transformOrigin = 'top center';
                        w.style.marginBottom = `${(pdfBS - 1) * w.offsetHeight * .5}px`;
                    });
                }, { passive: false });

                pdfBody.addEventListener('touchend', e => { if (e.touches.length < 2) pdfPD = null }, { passive: true });
            } catch (e) {
                pdfBody.innerHTML = `<div class="pdf-loading">ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ PDF<br><small>${escapeHTML(e.message || '')}</small></div>`;
            }
        }

        // === FILE HELPERS ===
        function formatBytes(n) { if (!n) return ""; const u = ["B", "KB", "MB", "GB"]; let i = 0, v = n; while (v >= 1024 && i < u.length - 1) { v /= 1024; i++ } return `${v.toFixed(v >= 10 || i === 0 ? 0 : 1)} ${u[i]}` }
        function fileIcon(mime, name) {
            const ext = (name.split('.').pop() || "").toLowerCase();
            if (mime.startsWith("image/") || ["png", "jpg", "jpeg", "webp", "gif"].includes(ext)) return "ğŸ–¼ï¸";
            if (mime.startsWith("video/") || ["mp4", "mov", "avi", "mkv", "webm"].includes(ext)) return "ğŸ¬";
            if (mime === "application/pdf" || ext === "pdf") return "ğŸ“„";
            if (["doc", "docx"].includes(ext)) return "ğŸ“";
            if (["ppt", "pptx"].includes(ext)) return "ğŸ“Š";
            return "ğŸ“";
        }
        function isImage(mime, name) { const ext = (name.split('.').pop() || "").toLowerCase(); return mime.startsWith("image/") || ["png", "jpg", "jpeg", "webp", "gif"].includes(ext) }
        function isVideo(mime, name) { const ext = (name.split('.').pop() || "").toLowerCase(); return mime.startsWith("video/") || ["mp4", "mov", "avi", "mkv", "webm"].includes(ext) }
        function isPDF(mime, name) { return mime === "application/pdf" || (name || "").toLowerCase().endsWith(".pdf") }

        async function uploadFiles(fileList) {
            const files = Array.from(fileList || []);
            if (!files.length) return [];
            const fd = new FormData();
            for (const f of files) fd.append("files", f, f.name);
            const res = await fetch("/api/upload", { method: "POST", body: fd });
            const json = await res.json();
            if (!res.ok || json.status !== "ok") throw new Error(json.message || "Upload failed");
            return json.files || [];
        }

        // === FILE PICKER (add form) ===
        let addFilesList = [];
        document.getElementById('add-files').addEventListener('change', e => {
            addFilesList = [...addFilesList, ...Array.from(e.target.files || [])];
            e.target.value = '';
            renderFP('add', addFilesList);
        });

        function renderFP(form, files) {
            const c = document.getElementById(`${form}-files-preview`);
            c.innerHTML = '';
            files.forEach((file, idx) => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                const th = document.createElement('div');
                th.className = 'fp-thumb';
                if (file.type.startsWith('image/')) {
                    const u = URL.createObjectURL(file);
                    th.innerHTML = `<img src="${u}" alt="">`;
                } else th.innerHTML = fileIcon(file.type, file.name);

                item.innerHTML = `<div class="fp-info"><div class="fp-name">${escapeHTML(file.name)}</div><div class="fp-size">${formatBytes(file.size)}</div></div><div class="fp-remove" onclick="removeFP('${form}',${idx})">âœ•</div>`;
                item.insertBefore(th, item.firstChild);
                c.appendChild(item);
            });
        }

        function removeFP(form, idx) {
            playVibration('light');
            if (form === 'add') addFilesList.splice(idx, 1);
            else editNewFiles.splice(idx, 1);
            renderFP(form, form === 'add' ? addFilesList : editNewFiles);
        }

        // === ATTACHMENTS (detail) ===
        function renderAttachments(task) {
            const block = document.getElementById("attachments-block"),
                list = document.getElementById("attachments-list"),
                atts = task.attachments || [];
            if (!atts.length) { block.style.display = "none"; list.innerHTML = ""; return }
            block.style.display = "block";
            list.innerHTML = '';
            atts.forEach(a => {
                const row = document.createElement('div');
                row.className = 'att-row';
                const mime = a.mime || "", name = a.name || "file";
                const th = document.createElement('div'); th.className = 'att-thumb';
                if (isImage(mime, name)) {
                    const img = document.createElement('img'); img.src = a.url; img.alt = ''; img.loading = 'lazy'; th.appendChild(img);
                } else if (isVideo(mime, name)) {
                    const v = document.createElement('video'); v.src = a.url; v.preload = 'metadata'; v.muted = true; v.style.pointerEvents = 'none'; th.appendChild(v);
                } else th.innerHTML = fileIcon(mime, name);

                row.innerHTML = `<div class="att-info"><div class="att-name">${escapeHTML(name)}</div><div class="att-meta">${a.size ? formatBytes(a.size) : ''}</div></div><div class="att-arr">â€º</div>`;
                row.insertBefore(th, row.firstChild);

                row.onclick = () => {
                    if (isImage(mime, name)) openImageViewer(a.url, name);
                    else if (isVideo(mime, name)) openVideoViewer(a.url, name);
                    else if (isPDF(mime, name)) openPdfViewer(a.url, name);
                    else window.open(a.url, "_blank");
                };
                list.appendChild(row);
            });
        }

        // === DETAIL LAYOUT (Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾) ===
        // â”€â”€ ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ñ– Ñ€ĞµĞ½Ğ´ĞµÑ€ Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ğ½ÑŒ Ñƒ Ñ‚ĞµĞºÑÑ‚Ñ– Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const URL_RE = /https?:\/\/[^\s\)\]>"]+/g;

        // Ğ†ĞºĞ¾Ğ½ĞºĞ° Ğ¿Ğ¾ Ğ´Ğ¾Ğ¼ĞµĞ½Ñƒ
        function linkIcon(hostname) {
            if (/youtube\.com|youtu\.be/.test(hostname)) return 'ğŸ¥';
            if (/docs\.google|drive\.google/.test(hostname)) return 'ğŸ“„';
            if (/classroom\.google/.test(hostname)) return 'ğŸ«';
            if (/meet\.google/.test(hostname)) return 'ğŸ“¹';
            if (/forms\.google/.test(hostname)) return 'ğŸ“‹';
            if (/telegram\.me|t\.me/.test(hostname)) return 'âœˆï¸';
            if (/instagram\.com/.test(hostname)) return 'ğŸ“¸';
            if (/github\.com/.test(hostname)) return 'ğŸ’»';
            if (/notion\.so/.test(hostname)) return 'ğŸ““';
            if (/figma\.com/.test(hostname)) return 'ğŸ¨';
            if (/wikipedia\.org/.test(hostname)) return 'ğŸ“–';
            return 'ğŸ”—';
        }

        // Ğ¡ĞºĞ¾Ñ€Ğ¾Ñ‡ĞµĞ½Ğ¸Ğ¹ display URL
        function shortUrl(url) {
            try {
                const u = new URL(url);
                return (u.hostname + u.pathname).replace(/\/$/, '').slice(0, 55);
            } catch { return url.slice(0, 55); }
        }

        // Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº (hostname Ğ±ĞµĞ· www)
        function linkTitle(url) {
            try {
                const host = new URL(url).hostname.replace(/^www\./, '');
                // Ğ’Ñ–Ğ´Ğ¾Ğ¼Ñ– ÑĞµÑ€Ğ²Ñ–ÑĞ¸ â€” ĞºÑ€Ğ°ÑĞ¸Ğ²Ñ– Ñ–Ğ¼ĞµĞ½Ğ°
                const names = {
                    'youtube.com': 'YouTube', 'youtu.be': 'YouTube',
                    'docs.google.com': 'Google Docs', 'drive.google.com': 'Google Drive',
                    'classroom.google.com': 'Google Classroom', 'meet.google.com': 'Google Meet',
                    'forms.google.com': 'Google Forms', 't.me': 'Telegram',
                    'telegram.me': 'Telegram', 'instagram.com': 'Instagram',
                    'github.com': 'GitHub', 'notion.so': 'Notion',
                    'figma.com': 'Figma', 'wikipedia.org': 'Wikipedia',
                };
                return names[host] || host;
            } catch { return url; }
        }

        function renderLinks(text, container) {
            container.innerHTML = '';
            const urls = [...new Set(text.match(URL_RE) || [])];
            urls.forEach(url => {
                let hostname = '';
                try { hostname = new URL(url).hostname; } catch { }

                const a = document.createElement('a');
                a.className = 'link-card';
                a.href = url;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                // Telegram WebApp â€” Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ğ²Ğ°Ñ”Ğ¼Ğ¾ Ñ‡ĞµÑ€ĞµĞ· tg.openLink ÑĞºÑ‰Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾
                a.onclick = (e) => {
                    e.preventDefault();
                    playVibration('light');
                    if (tg.openLink) tg.openLink(url);
                    else window.open(url, '_blank');
                };

                const iconWrap = document.createElement('div');
                iconWrap.className = 'link-icon-wrap';

                // Ğ¡Ğ¿Ñ€Ğ¾Ğ±ÑƒÑ”Ğ¼Ğ¾ favicon Ñ‡ĞµÑ€ĞµĞ· Google S2
                const faviconUrl = `https://www.google.com/s2/favicons?domain=${hostname}&sz=64`;
                const img = document.createElement('img');
                img.className = 'link-favicon';
                img.src = faviconUrl;
                img.alt = '';
                img.onerror = () => {
                    iconWrap.innerHTML = `<span style="font-size:20px">${linkIcon(hostname)}</span>`;
                };
                iconWrap.appendChild(img);

                const info = document.createElement('div');
                info.className = 'link-info';
                info.innerHTML = `
                    <div class="link-title">${escapeHTML(linkTitle(url))}</div>
                    <div class="link-url">${escapeHTML(shortUrl(url))}</div>
                `;

                const arr = document.createElement('div');
                arr.className = 'link-arr';
                arr.textContent = 'â€º';

                a.appendChild(iconWrap);
                a.appendChild(info);
                a.appendChild(arr);
                container.appendChild(a);
            });
        }

        function fillDetailModal(task) {
            currentTask = task;
            document.getElementById('modal-subj').innerText = task.subject;
            // Ğ‘ĞµĞ¹Ğ´Ğ¶ Ğ²Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğ¾Ğ³Ğ¾
            const impBadge = document.getElementById('detail-important-badge');
            if (impBadge) impBadge.style.display = task.is_important ? 'inline-flex' : 'none';
            document.getElementById('modal-desc').innerText = task.description;
            renderLinks(task.description || '', document.getElementById('modal-links'));

            // date chip
            const dateChip = document.getElementById('modal-datechip');
            dateChip.textContent = task.date ? `ğŸ“… ${prettyDate(task.date)}` : 'ğŸ“… â€”';

            // author chip (admin badge Ğ²ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ–, Ğ°Ğ»Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾)
            const isAuthorAdmin = task.author_id != null && Number(task.author_id) === ADMIN_ID;
            const authorChip = document.getElementById('modal-authorchip');
            const authorName = task.author || "â€”";
            authorChip.innerHTML = isAuthorAdmin
                ? `<span class="admin-badge" style="margin-right:6px; animation:none;">ADMIN</span>${escapeHTML(authorName)}`
                : `ğŸ‘¤ ${escapeHTML(authorName)}`;

            document.getElementById('admin-actions').style.display = isAdmin ? 'flex' : 'none';

            // pills centered
            const pills = document.getElementById('week-pills');
            pills.innerHTML = '';
            DAYS_FULL.forEach((d, i) => {
                const p = document.createElement('div');
                p.className = 'pill';
                p.innerText = DAYS_SHORT[i];
                if (SCHEDULE[d]?.includes(task.subject)) p.classList.add('active');
                pills.appendChild(p);
            });

            renderAttachments(task);
        }

        // === ADD FORM ===
        function setupAddForm() {
            const sel = document.getElementById('add-subj');
            sel.innerHTML = '';
            ALL_SUBJECTS.forEach(s => {
                const o = document.createElement('option');
                o.value = s; o.innerText = s;
                sel.appendChild(o);
            });

            applySubjectSearch('add-subj-search', 'add-subj');

            document.getElementById('add-desc').value = '';
            addFilesList = []; renderFP('add', []);
            addDateTouched = false;
            document.getElementById('add-important').checked = false;

            const cur = getCurrentSubject();
            if (cur) {
                sel.value = cur;
                document.getElementById('add-date').value = getNextDateForSubject(cur);
            } else {
                sel.selectedIndex = 0;
                document.getElementById('add-date').value = getNextDateForSubject(sel.value);
            }

            const addDate = document.getElementById('add-date');
            addDate.onchange = () => { addDateTouched = true };
        }

        document.getElementById('add-subj').addEventListener('change', e => {
            playVibration('light');
            if (!addDateTouched) document.getElementById('add-date').value = getNextDateForSubject(e.target.value);
        });

        async function submitHW() {
            const btn = document.getElementById('btn-add-save');
            await runGuard('add_save', async () => {
                const date = document.getElementById('add-date').value;
                const subj = document.getElementById('add-subj').value;
                const desc = document.getElementById('add-desc').value.trim();
                if (!date || !subj || !desc) { tg.showAlert("Ğ‘ÑƒĞ´ÑŒ Ğ»Ğ°ÑĞºĞ°, Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½Ñ–Ñ‚ÑŒ Ğ²ÑÑ– Ğ¿Ğ¾Ğ»Ñ!"); return }

                const author = tg.initDataUnsafe?.user?.first_name || "Mini App";
                const author_id = tg.initDataUnsafe?.user?.id ?? null;

                playVibration('medium');

                let uploaded = [];
                if (addFilesList.length) {
                    const dt = new DataTransfer();
                    addFilesList.forEach(f => dt.items.add(f));
                    uploaded = await uploadFiles(dt.files);
                }

                await fetch('/api/hw_add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, subject: subj, description: desc, author, author_id, attachments: uploaded, is_important: document.getElementById('add-important').checked ? 1 : 0 })
                });

                tg.showAlert("âœ… Ğ—Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ Ğ´Ğ¾Ğ´Ğ°Ğ½Ğ¾!");
                popModal();
                await fetchHW({ silent: false, showOverlay: false });
            }, {
                btn,
                overlayTitle: "Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾â€¦",
                overlaySub: "Ğ™Ğ´Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ² / Ğ·Ğ°Ğ¿Ğ¸Ñ Ñƒ Ğ±Ğ°Ğ·Ñƒ",
                useOverlay: true
            });
        }

        // === EDIT ATTACHMENTS ===
        let editAttList = [], editNewFiles = [], replaceTargetIdx = -1;
        const replInput = document.getElementById('replace-file-input');

        replInput.addEventListener('change', e => {
            const f = e.target.files[0];
            if (!f || replaceTargetIdx < 0) return;
            e.target.value = '';
            editAttList[replaceTargetIdx] = { name: f.name, size: f.size, _file: f, _isNew: true };
            replaceTargetIdx = -1;
            renderEditAtt();
        });

        document.getElementById('edit-files').addEventListener('change', e => {
            editNewFiles = [...editNewFiles, ...Array.from(e.target.files || [])];
            e.target.value = '';
            editNewFiles.forEach(f => {
                if (!editAttList.some(a => a._isNew && a._file === f)) editAttList.push({ name: f.name, size: f.size, _file: f, _isNew: true });
            });
            renderEditAtt();
        });

        function renderEditAtt() {
            const c = document.getElementById('edit-att-list');
            c.innerHTML = '';
            if (!editAttList.length) {
                c.innerHTML = '<div style="color:var(--muted);font-size:14px;padding:6px 0 4px">ĞĞµĞ¼Ğ°Ñ” Ğ²ĞºĞ»Ğ°Ğ´ĞµĞ½ÑŒ</div>';
                return;
            }
            editAttList.forEach((a, idx) => {
                const row = document.createElement('div');
                row.className = 'att-row att-row-edit';
                const mime = a.mime || "", name = a.name || "file";
                const th = document.createElement('div');
                th.className = 'att-thumb';

                if (a._isNew && a._file?.type?.startsWith('image/')) {
                    const u = URL.createObjectURL(a._file);
                    th.innerHTML = `<img src="${u}" alt="">`;
                } else if (isImage(mime, name) && a.url) {
                    const img = document.createElement('img'); img.src = a.url; img.alt = ''; th.appendChild(img);
                } else if (isVideo(mime, name) && a.url) {
                    const v = document.createElement('video'); v.src = a.url; v.preload = 'metadata'; v.muted = true; v.style.pointerEvents = 'none'; th.appendChild(v);
                } else th.innerHTML = fileIcon(a._isNew ? (a._file?.type || "") : mime, name);

                const info = document.createElement('div');
                info.style = 'flex:1;min-width:0';
                info.innerHTML = `<div class="att-name">${escapeHTML(name)}</div><div class="att-meta">${a._isNew ? 'â— ĞĞ¾Ğ²Ğµ  ' : ''} ${formatBytes(a.size)}</div>`;

                const btns = document.createElement('div');
                btns.className = 'att-edit-btns';

                if (!a._isNew) {
                    const rb = document.createElement('div');
                    rb.className = 'att-btn-replace';
                    rb.textContent = 'Ğ—Ğ°Ğ¼Ñ–Ğ½Ğ¸Ñ‚Ğ¸';
                    rb.onclick = () => { replaceTargetIdx = idx; replInput.click() };
                    btns.appendChild(rb);
                }

                const db = document.createElement('div');
                db.className = 'att-btn-del';
                db.textContent = 'âœ•';
                db.onclick = () => { playVibration('light'); editAttList.splice(idx, 1); renderEditAtt() };
                btns.appendChild(db);

                row.appendChild(th); row.appendChild(info); row.appendChild(btns);
                c.appendChild(row);
            });
        }

        function openEditModal() {
            if (!currentTask) { tg.showAlert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°"); return }

            const sel = document.getElementById('edit-subj');
            sel.innerHTML = '';
            ALL_SUBJECTS.forEach(s => {
                const o = document.createElement('option');
                o.value = s; o.innerText = s;
                sel.appendChild(o);
            });

            applySubjectSearch('edit-subj-search', 'edit-subj');

            sel.value = currentTask.subject;

            const editDate = document.getElementById('edit-date');
            editDate.value = currentTask.date;
            editDateTouched = false;
            editDate.onchange = () => { editDateTouched = true };

            document.getElementById('edit-desc').value = currentTask.description;
            document.getElementById('edit-important').checked = !!currentTask.is_important;

            editAttList = (currentTask.attachments || []).map(a => ({ ...a, _isNew: false }));
            editNewFiles = []; renderEditAtt(); renderFP('edit', []);

            openModal('edit-hw-modal');
        }

        document.getElementById('edit-subj').addEventListener('change', e => {
            playVibration('light');
            if (!editDateTouched) document.getElementById('edit-date').value = getNextDateForSubject(e.target.value);
        });

        async function submitEdit() {
            const btn = document.getElementById('btn-edit-save');
            await runGuard('edit_save', async () => {
                const subject = document.getElementById('edit-subj').value;
                const date = document.getElementById('edit-date').value;
                const desc = document.getElementById('edit-desc').value.trim();
                if (!subject || !date || !desc) { tg.showAlert("Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½Ñ–Ñ‚ÑŒ Ğ²ÑÑ– Ğ¿Ğ¾Ğ»Ñ!"); return }

                playVibration('medium');

                const finalAtts = [];
                for (const a of editAttList) {
                    if (a._isNew) {
                        const dt = new DataTransfer();
                        dt.items.add(a._file);
                        const up = await uploadFiles(dt.files);
                        if (up[0]) finalAtts.push(up[0]);
                    } else {
                        const sn = a.url?.split('/files/')[1] || a.stored_name;
                        finalAtts.push({ name: a.name, stored_name: sn, mime: a.mime, size: a.size });
                    }
                }

                await fetch('/api/hw_update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: currentTask.id, subject, date, description: desc, attachments: finalAtts, is_important: document.getElementById('edit-important').checked ? 1 : 0 })
                });

                closeModalById('edit-hw-modal');
                closeModalById('detail-modal');
                await fetchHW({ silent: false, showOverlay: false });
            }, {
                btn,
                overlayTitle: "Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ¸â€¦",
                overlaySub: "ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ Ñ‚Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞµĞ½Ğ½Ñ",
                useOverlay: true
            });
        }

        async function confirmDelete() {
            if (!currentTask) { tg.showAlert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°"); return }
            const ok = window.confirm(`Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ "${currentTask.subject}"?\n${currentTask.description}`);
            if (!ok) return;

            const btn = document.getElementById('btn-del');
            await runGuard('delete_hw', async () => {
                playVibration('heavy');
                await fetch('/api/hw_delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: currentTask.id })
                });
                closeModalById('detail-modal');
                await fetchHW({ silent: false, showOverlay: false });
            }, {
                btn,
                overlayTitle: "Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾â€¦",
                overlaySub: "ĞŸÑ€Ğ¸Ğ±Ğ¸Ñ€Ğ°Ñ”Ğ¼Ğ¾ Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ Ñ‚Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¸",
                useOverlay: true
            });
        }

        // === FETCH ===
        function tabsSig(d) { return Object.keys(d || {}).map(k => `${k}:${d[k]?.label || ""}`).join("|") }
        function getAllIds(arr) { return new Set((arr || []).map(t => String(t.id))) }

        async function fetchHW(opts = {}) {
            const { silent = false, showOverlay = true } = opts;
            if (isFetching) return;
            isFetching = true;

            const shouldOverlay = (!silent && showOverlay);

            try {
                if (shouldOverlay) showLoading("ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñâ€¦", "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ñ–Ğ·Ğ°Ñ†Ñ–Ñ Ğ· ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼");
                const [r1, r2] = await Promise.all([fetch('/api/hw'), fetch('/api/hw_all')]);
                const nd = await r1.json(), na = await r2.json();

                const prev = getAllIds(allHWData), next = getAllIds(na);
                newlyAddedIds = new Set();
                for (const id of next) if (!prev.has(id)) newlyAddedIds.add(id);

                hwData = nd; allHWData = na; tabKeys = Object.keys(hwData);

                const sig = tabsSig(hwData);
                if (sig !== lastTabsSig) { lastTabsSig = sig; renderTabsOnce() }
                else updateTabsInd();

                reconcileHWList(currentMainDateKey);
                if (modalStack.includes('all-hw-modal')) reconcileAllHWList();

                didFirstLoad = true;
                if (newlyAddedIds.size > 0) setTimeout(() => newlyAddedIds.clear(), 2500);
            } catch (e) {
                if (!didFirstLoad && !silent) document.getElementById('hw-container').innerHTML = '<div class="empty-state">ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·\'Ñ”Ğ´Ğ½Ğ°Ğ½Ğ½Ñ</div>';
            } finally {
                if (shouldOverlay) hideLoading();
                isFetching = false;
            }
        }

        function moveInd(id, index, total) {
            const el = document.getElementById(id);
            el.style.width = `calc(${100 / total}% - 6px)`;
            el.style.transform = `translateX(calc(${index * 100}% + ${index * 6}px))`;
        }

        function renderTabsOnce() {
            const c = document.getElementById('tabs-container');
            c.innerHTML = "";
            if (!tabKeys.length) {
                document.getElementById('hw-container').innerHTML = '<div class="empty-state">Ğ—Ğ°Ğ²Ğ´Ğ°Ğ½ÑŒ Ğ½ĞµĞ¼Ğ°Ñ”</div>';
                return;
            }
            if (!currentMainDateKey || !tabKeys.includes(currentMainDateKey)) currentMainDateKey = tabKeys[0];

            tabKeys.forEach(day => {
                const tab = document.createElement('div');
                tab.className = `tab pressable ${day === currentMainDateKey ? 'active' : ''}`;
                tab.innerText = hwData[day].label;
                tab.onclick = () => {
                    if (day === currentMainDateKey) return; // Ğ°Ğ½Ñ‚Ğ¸-ÑĞ¿Ğ°Ğ¼ Ğ¿Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¼Ñƒ Ñ‚Ğ°Ğ±Ñƒ
                    c.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentMainDateKey = day;
                    updateTabsInd();
                    playVibration('medium');
                    reconcileHWList(day, { forceRebuild: true });
                };
                tab.addEventListener('pointerdown', () => PressFX.down(tab));
                tab.addEventListener('pointerup', () => PressFX.up(tab));
                tab.addEventListener('pointercancel', () => PressFX.up(tab));
                c.appendChild(tab);
            });

            updateTabsInd();
            reconcileHWList(currentMainDateKey, { forceRebuild: true });
        }

        function updateTabsInd() {
            if (!tabKeys.length) return;
            moveInd('tab-indicator', tabKeys.indexOf(currentMainDateKey), tabKeys.length);
        }

        function createHWCard(task, dateKey) {
            const card = document.createElement('div');
            const isNew = newlyAddedIds.has(String(task.id));
            card.className = 'hw-card' + (isNew ? ' new-task' : '') + (task.is_important ? ' important' : '');
            card.dataset.id = String(task.id);
            card.dataset.important = task.is_important ? '1' : '0';
            card.style.animation = `slideUpFade 0.45s cubic-bezier(0.2,0.8,0.2,1) forwards ${isNew ? 0 : 0.02}s`;
            const clip = (task.attachments?.length) ? " ğŸ“" : "";
            const impBadge = task.is_important ? '<div class="important-badge">ğŸ”´ Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğµ</div>' : '';
            card.innerHTML = `${impBadge}<div class="subj-title">${escapeHTML(task.subject)}${clip}</div><div class="hw-short">${escapeHTML(task.description)}</div>`;
            card.onclick = () => openModal('detail-modal', () => fillDetailModal({ ...task, date: dateKey }));
            return card;
        }

        function reconcileHWList(dateKey, opts = {}) {
            const { forceRebuild = false } = opts;
            const c = document.getElementById('hw-container');
            // Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ñ– Ğ²Ğ³Ğ¾Ñ€Ñ–
            const rawTasks = hwData[dateKey]?.tasks || [];
            const tasks = [...rawTasks.filter(t => t.is_important), ...rawTasks.filter(t => !t.is_important)];
            if (!tasks.length) {
                if (!c.dataset.emptyShown || forceRebuild) {
                    c.dataset.emptyShown = "1";
                    c.innerHTML = '<div class="empty-state">ĞĞ° Ñ†ĞµĞ¹ Ğ´ĞµĞ½ÑŒ Ğ”/Ğ— Ğ½ĞµĞ¼Ğ°Ñ”</div>';
                }
                return;
            }
            c.dataset.emptyShown = "";
            if (forceRebuild) c.innerHTML = "";

            const existing = new Map();
            c.querySelectorAll('.hw-card').forEach(el => existing.set(el.dataset.id, el));
            const nextOrder = tasks.map(t => String(t.id));

            for (const t of tasks) {
                const id = String(t.id), found = existing.get(id);
                if (!found) c.appendChild(createHWCard(t, dateKey));
                else {
                    const clip = (t.attachments?.length) ? " ğŸ“" : "";
                    const titleText = `${t.subject}${clip}`;
                    const te = found.querySelector('.subj-title'), de = found.querySelector('.hw-short');
                    if (te && te.textContent !== titleText) te.textContent = titleText;
                    if (de && de.textContent !== t.description) de.textContent = t.description;
                    found.onclick = () => openModal('detail-modal', () => fillDetailModal({ ...t, date: dateKey }));
                }
            }
            for (const [id, el] of existing.entries()) if (!nextOrder.includes(id)) el.remove();

            let ptr = c.firstElementChild;
            for (const id of nextOrder) {
                const el = c.querySelector(`.hw-card[data-id="${CSS.escape(id)}"]`);
                if (!el) continue;
                if (el !== ptr) c.insertBefore(el, ptr);
                ptr = el.nextElementSibling;
            }
        }

        let currentAllHwMode = 'date', currentActiveFilter = null;
        let allModeLock = 0;

        function reconcileAllHWList() {
            const sig = (allHWData || []).map(t => `${t.id}:${t.date}:${(t.attachments || []).length}`).join("|");
            if (sig === lastAllSig) return;
            lastAllSig = sig;
            renderAllHW();
        }

        // ====== ĞŸĞ›ĞĞ’ĞĞ˜Ğ™ ĞŸĞ•Ğ Ğ•ĞœĞ˜ĞšĞĞ§ "Ğ—Ğ° Ğ´Ğ°Ñ‚Ğ¾Ñ / Ğ—Ğ° Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ¾Ğ¼" Ğ±ĞµĞ· ÑĞ¿Ğ°Ğ¼Ñƒ ======
        function selectAllMode(mode, el) {
            const now = performance.now();
            if (now - allModeLock < 120) return;
            allModeLock = now;

            if (mode === currentAllHwMode) {
                // Ğ½Ğ°Ñ‚Ğ¸ÑĞº Ğ¿Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¼Ñƒ â€” Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ»ĞµĞ³ĞºĞ¸Ğ¹ feedback, Ğ±ĞµĞ· Ğ¿ĞµÑ€ĞµÑ€ĞµĞ½Ğ´ĞµÑ€Ñƒ
                PressFX.tap(el, 80);
                playVibration('light');
                return;
            }

            PressFX.tap(el, 80);
            playVibration('light');
            renderAllHW(mode);
        }

        // ====== Ğ¤Ğ†Ğ›Ğ¬Ğ¢Ğ Ğ˜ "Ğ¡ÑŒĞ¾Ğ³Ğ¾Ğ´Ğ½Ñ–/Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°/Ğ´Ğ°Ñ‚Ğ°" Ğ±ĞµĞ· ÑĞ¿Ğ°Ğ¼Ñƒ ======
        const allFilterLock = { t: 0 };

        function renderAllHW(mode) {
            if (mode) currentAllHwMode = mode;
            const isDate = currentAllHwMode === 'date';
            document.getElementById('tab-sort-date').classList.toggle('active', isDate);
            document.getElementById('tab-sort-subj').classList.toggle('active', !isDate);
            moveInd('all-hw-indicator', isDate ? 0 : 1, 2);

            const fc = document.getElementById('all-hw-filters');
            fc.innerHTML = '';

            if (!allHWData.length) {
                document.getElementById('all-hw-list').innerHTML = '<div class="empty-state">Ğ—Ğ°Ğ²Ğ´Ğ°Ğ½ÑŒ Ğ½ĞµĞ¼Ğ°Ñ”</div>';
                return;
            }

            let keys = isDate
                ? [...new Set(allHWData.map(t => t.date))].sort()
                : [...new Set(allHWData.map(t => t.subject))].sort();

            if (!keys.includes(currentActiveFilter)) currentActiveFilter = keys[0];

            const todayISO = localISO(new Date());
            const tomorrowISO = addDaysISO(todayISO, 1);
            const yesterdayISO = subDaysISO(todayISO, 1);
            const dayBeforeISO = subDaysISO(todayISO, 2);

            keys.forEach(key => {
                const p = document.createElement('div');
                p.className = `filter-pill pressable ${key === currentActiveFilter ? 'active' : ''}`;

                if (isDate) {
                    const d = new Date(key + "T00:00:00");
                    if (key === todayISO) p.innerText = "Ğ¡ÑŒĞ¾Ğ³Ğ¾Ğ´Ğ½Ñ–";
                    else if (key === tomorrowISO) p.innerText = "Ğ—Ğ°Ğ²Ñ‚Ñ€Ğ°";
                    else if (key === yesterdayISO) p.innerText = "Ğ’Ñ‡Ğ¾Ñ€Ğ°";
                    else if (key === dayBeforeISO) p.innerText = "ĞŸĞ¾Ğ·Ğ°Ğ²Ñ‡Ğ¾Ñ€Ğ°";
                    else p.innerText = d.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' });
                } else p.innerText = key;

                p.addEventListener('pointerdown', () => PressFX.down(p));
                const up = () => PressFX.up(p);
                p.addEventListener('pointerup', up);
                p.addEventListener('pointercancel', up);
                p.addEventListener('pointerleave', up);

                p.onclick = () => {
                    const now = performance.now();
                    if (now - allFilterLock.t < 120) return;
                    allFilterLock.t = now;

                    playVibration('light');
                    PressFX.tap(p, 80);

                    if (key === currentActiveFilter) return;

                    currentActiveFilter = key;

                    // Ğ¿ĞµÑ€ĞµĞ¼Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ active Ğ±ĞµĞ· Ğ¿ĞµÑ€ĞµÑ€ĞµĞ½Ğ´ĞµÑ€Ñƒ pills
                    fc.querySelectorAll('.filter-pill').forEach(x => x.classList.remove('active'));
                    p.classList.add('active');

                    // Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ÑĞ¿Ğ¸ÑĞ¾Ğº
                    renderAllHWListOnly();
                };

                fc.appendChild(p);
            });

            const list = document.getElementById('all-hw-list');
            list.innerHTML = '';
            const filteredTasks = allHWData.filter(t => isDate ? t.date === currentActiveFilter : t.subject === currentActiveFilter);
            const sortedTasks = [...filteredTasks.filter(t => t.is_important), ...filteredTasks.filter(t => !t.is_important)];
            sortedTasks.forEach((task, i) => {
                    const card = document.createElement('div');
                    card.className = `hw-card ${newlyAddedIds.has(String(task.id)) ? 'new-task' : ''} ${task.is_important ? 'important' : ''}`;
                    card.style.animation = `slideUpFade .4s forwards ${i * 0.05}s`;
                    const clip = (task.attachments?.length) ? " ğŸ“" : "";
                    const titleText = isDate
                        ? task.subject
                        : new Date(task.date + "T00:00:00").toLocaleDateString('uk-UA', { day: 'numeric', month: 'long' });

                    const impB = task.is_important ? '<div class="important-badge">ğŸ”´ Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğµ</div>' : '';
                    card.innerHTML = `${impB}<div class="subj-title">${escapeHTML(titleText)}${clip}</div><div class="hw-short">${escapeHTML(task.description)}</div>`;
                    card.onclick = () => openModal('detail-modal', () => fillDetailModal(task));
                    list.appendChild(card);
                });
        }

        function renderAllHWListOnly() {
            const isDate = currentAllHwMode === 'date';
            const list = document.getElementById('all-hw-list');
            list.innerHTML = '';

            const rawFiltered = allHWData.filter(t => isDate ? t.date === currentActiveFilter : t.subject === currentActiveFilter);
            const tasks = [...rawFiltered.filter(t => t.is_important), ...rawFiltered.filter(t => !t.is_important)];

            if (!tasks.length) {
                list.innerHTML = '<div class="empty-state">ĞĞµĞ¼Ğ°Ñ” Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½ÑŒ</div>';
                return;
            }

            tasks.forEach((task, i) => {
                const card = document.createElement('div');
                card.className = `hw-card ${newlyAddedIds.has(String(task.id)) ? 'new-task' : ''} ${task.is_important ? 'important' : ''}`;
                card.style.animation = `slideUpFade .4s forwards ${i * 0.05}s`;

                const clip = (task.attachments?.length) ? " ğŸ“" : "";
                const titleText = isDate
                    ? task.subject
                    : new Date(task.date + "T00:00:00").toLocaleDateString('uk-UA', { day: 'numeric', month: 'long' });

                const impBL = task.is_important ? '<div class="important-badge">ğŸ”´ Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğµ</div>' : '';
                card.innerHTML = `${impBL}<div class="subj-title">${escapeHTML(titleText)}${clip}</div><div class="hw-short">${escapeHTML(task.description)}</div>`;
                card.onclick = () => openModal('detail-modal', () => fillDetailModal(task));
                list.appendChild(card);
            });
        }

        function openSchedule() {
            const st = document.getElementById('sched-tabs');
            st.innerHTML = '';
            let di = new Date().getDay() - 1;
            if (di < 0 || di > 4) di = 0;

            DAYS_FULL.forEach((d, i) => {
                const tab = document.createElement('div');
                tab.className = `filter-pill pressable ${i === di ? 'active' : ''}`;
                tab.innerText = d;

                tab.addEventListener('pointerdown', () => PressFX.down(tab));
                const up = () => PressFX.up(tab);
                tab.addEventListener('pointerup', up);
                tab.addEventListener('pointercancel', up);
                tab.addEventListener('pointerleave', up);

                tab.onclick = () => {
                    if (tab.classList.contains('active')) return;
                    document.querySelectorAll('#sched-tabs .filter-pill').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    playVibration('medium');
                    renderScheduleDay(d);
                };
                st.appendChild(tab);
            });

            renderScheduleDay(DAYS_FULL[di]);
        }

        function renderScheduleDay(dayName) {
            const list = document.getElementById('schedule-list');
            list.innerHTML = '';
            const subjects = SCHEDULE[dayName] || [];
            if (!subjects.length) {
                list.innerHTML = '<div class="empty-state">Ğ¡ÑŒĞ¾Ğ³Ğ¾Ğ´Ğ½Ñ– ÑƒÑ€Ğ¾ĞºÑ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ”</div>';
                return;
            }
            let li = 0;
            BELLS.forEach((bell, index) => {
                const isCur = isCurrentLesson(bell, dayName),
                    cls = isCur ? 'current-lesson' : '',
                    badge = isCur ? '<span class="current-badge">Ğ—Ğ°Ñ€Ğ°Ğ·</span>' : '';

                if (bell.isBreak) {
                    list.innerHTML += `<div class="lesson-row lesson-break ${cls}" style="animation:slideUpFade .4s forwards ${index * .05}s">ĞĞ±Ñ–Ğ´Ğ½Ñ Ğ¿ĞµÑ€ĞµÑ€Ğ²Ğ° (${bell.s} â€“ ${bell.e}) ${badge}</div>`;
                    return;
                }
                if (li < subjects.length) {
                    const subj = subjects[li];
                    list.innerHTML += `<div class="lesson-row ${cls}" style="animation:slideUpFade .4s forwards ${index * .05}s"><div class="lesson-num">${bell.num}</div><div class="lesson-time">${bell.s}</div><div class="lesson-name">${escapeHTML(subj)} ${badge}</div></div>`;
                    li++;
                }
            });
        }

        // ========= MODAL STACK BACK BTN =========
        // (Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¸Ğ² Ğ±ĞµĞ· Ğ·Ğ¼Ñ–Ğ½)

        // ========= START =========
        (function runIntro() {
            const el = document.getElementById('intro-overlay');
            if (!el) { fetchHW({ silent: false }); return; }
            // ĞŸĞµÑ€ÑˆĞ¸Ğ¹ fetchHW â€” Ğ±ĞµĞ· loading overlay Ñ‰Ğ¾Ğ± Ñ–Ğ½Ñ‚Ñ€Ğ¾ Ğ½Ğµ Ğ½Ğ°ĞºÑ€Ğ¸Ğ²Ğ°Ğ»Ğ¾ÑÑŒ
            fetchHW({ silent: false, showOverlay: false });
            setTimeout(() => {
                el.classList.add('out');
                el.addEventListener('animationend', () => {
                    el.classList.add('gone');
                }, { once: true });
            }, 1600);
        })();
        setInterval(() => { if (!modalStack.includes('edit-hw-modal')) fetchHW({ silent: true, showOverlay: false }) }, 10000);
    </script>
</body>

</html>